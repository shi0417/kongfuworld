# 小说审核页面技术文档

## 一、概述

小说审核页面是后台管理系统的核心功能模块，用于管理员审核作者提交的小说。页面支持查看待审核小说列表、筛选不同状态的小说、查看详情以及执行批准/拒绝操作。

---

## 二、前端设计

### 2.1 文件结构

- **主组件文件**: `frontend/src/pages/AdminPanel/NovelReview/index.tsx` (362行)
- **样式文件**: `frontend/src/pages/AdminPanel/NovelReview/NovelReview.module.css` (253行)
- **父组件**: `frontend/src/pages/AdminPanel.tsx` (集成在管理面板中)

### 2.2 组件结构

```typescript
interface Novel {
  id: number;
  title: string;
  author: string;
  translator: string | null;
  description: string | null;
  cover: string | null;
  review_status: string;  // 'created' | 'submitted' | 'reviewing' | 'approved' | 'rejected' | 'locked'
  status: string;
  created_at: string;
  author_name?: string;
  pen_name?: string;
}

interface NovelReviewProps {
  onError?: (error: string) => void;
}
```

### 2.3 状态管理

组件使用React Hooks管理以下状态：

```typescript
const [novels, setNovels] = useState<Novel[]>([]);           // 小说列表
const [selectedNovel, setSelectedNovel] = useState<Novel | null>(null);  // 选中的小说详情
const [filterStatus, setFilterStatus] = useState<string>('all');  // 筛选状态
const [loading, setLoading] = useState(false);              // 加载状态
```

### 2.4 UI组件结构

#### 2.4.1 页面布局
```
┌─────────────────────────────────────────┐
│  小说审批 (标题)                         │
│  [全部待审批][已提交][审核中][已批准][已拒绝] │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐ │
│  │ [封面] 小说信息卡片                  │ │
│  │  标题、作者、翻译、状态、描述         │ │
│  │  [查看详情][批准][拒绝]              │ │
│  └───────────────────────────────────┘ │
│  ...更多小说卡片...                      │
└─────────────────────────────────────────┘
```

#### 2.4.2 筛选按钮组
- **全部待审批** (`filterStatus='all'`): 显示所有待审批小说（created, submitted, reviewing）
- **已提交** (`filterStatus='submitted'`): 仅显示已提交状态
- **审核中** (`filterStatus='reviewing'`): 仅显示审核中状态
- **已批准** (`filterStatus='approved'`): 仅显示已批准状态
- **已拒绝** (`filterStatus='rejected'`): 仅显示已拒绝状态（实际后端返回locked）

#### 2.4.3 小说卡片
每个小说卡片包含：
- **封面图片**: 120x160px，圆角显示
- **基本信息**: 标题、作者、翻译者
- **状态标签**: 带颜色标识（黄色=已提交，蓝色=审核中，绿色=已批准，红色=已拒绝）
- **描述预览**: 显示前100个字符
- **操作按钮**: 
  - 查看详情（灰色）
  - 批准（绿色，仅submitted/reviewing状态显示）
  - 拒绝（红色，仅submitted/reviewing状态显示）

#### 2.4.4 详情模态框
点击"查看详情"后弹出模态框，显示：
- 小说封面（大图）
- 完整信息：作者、翻译、状态、创建时间
- 完整描述
- 操作按钮（如果状态为submitted/reviewing）

### 2.5 样式设计

#### 2.5.1 状态标签颜色
```css
.status.submitted { background: #ffc107; color: #000; }  /* 黄色 */
.status.reviewing { background: #17a2b8; color: white; }   /* 蓝色 */
.status.approved { background: #28a745; color: white; }    /* 绿色 */
.status.rejected { background: #dc3545; color: white; }    /* 红色 */
```

#### 2.5.2 按钮样式
- **查看详情**: `#6c757d` (灰色)
- **批准**: `#28a745` (绿色)
- **拒绝**: `#dc3545` (红色)

### 2.6 核心功能函数

#### 2.6.1 通用API请求函数
```typescript
const adminApiRequest = async (endpoint: string, options: RequestInit = {}) => {
  // 自动添加Authorization token
  // 处理FormData和JSON格式
  // Token过期自动处理
  // 统一错误处理
}
```

#### 2.6.2 加载小说列表
```typescript
const loadNovels = async () => {
  // 根据filterStatus选择API端点
  // filterStatus === 'all' → GET /admin/pending-novels
  // 其他状态 → GET /admin/novels?status={filterStatus}
  // 更新novels状态
}
```

#### 2.6.3 查看详情
```typescript
const viewNovelDetail = async (novelId: number) => {
  // GET /admin/novel/:id
  // 设置selectedNovel状态，触发模态框显示
}
```

#### 2.6.4 处理审批
```typescript
const handleReview = async (novelId: number, action: 'approve' | 'reject') => {
  // 确认对话框
  // POST /admin/review-novel
  // body: { novelId, action }
  // 成功后刷新列表，关闭模态框
}
```

### 2.7 交互流程

1. **页面加载**: `useEffect`监听`filterStatus`变化，自动调用`loadNovels()`
2. **筛选切换**: 点击筛选按钮 → 更新`filterStatus` → 触发`useEffect` → 重新加载数据
3. **查看详情**: 点击"查看详情" → 调用`viewNovelDetail()` → 显示模态框
4. **审批操作**: 点击"批准"/"拒绝" → 确认对话框 → 调用`handleReview()` → 刷新列表

---

## 三、后端业务逻辑

### 3.1 API端点

#### 3.1.1 获取待审批小说列表
```
GET /api/admin/pending-novels
Headers: Authorization: Bearer {token}
Response: {
  success: boolean,
  data: Novel[]
}
```

**业务逻辑**:
- 查询`review_status IN ('created', 'submitted', 'reviewing')`的小说
- LEFT JOIN `user`表获取作者信息（username, pen_name）
- 按ID降序排列（最新在前）

**SQL查询**:
```sql
SELECT n.*, u.username as author_name, u.pen_name
FROM novel n
LEFT JOIN user u ON (n.author = u.pen_name OR n.author = u.username)
WHERE n.review_status IN ('created', 'submitted', 'reviewing')
ORDER BY n.id DESC
```

#### 3.1.2 获取筛选后的小说列表
```
GET /api/admin/novels?status={status}&page={page}&limit={limit}
Headers: Authorization: Bearer {token}
Query Parameters:
  - status: 'submitted' | 'reviewing' | 'approved' | 'rejected' | ...
  - page: 页码（默认1）
  - limit: 每页数量（默认20）
Response: {
  success: boolean,
  data: Novel[],
  pagination: {
    page: number,
    limit: number,
    total: number,
    totalPages: number
  }
}
```

**业务逻辑**:
- 根据status参数筛选（可选）
- 支持分页
- 返回总数和分页信息

#### 3.1.3 获取小说详情
```
GET /api/admin/novel/:id
Headers: Authorization: Bearer {token}
Response: {
  success: boolean,
  data: Novel
}
```

**业务逻辑**:
- 查询指定ID的小说
- JOIN `user`表获取作者详细信息（包括email）
- 如果不存在返回404

**SQL查询**:
```sql
SELECT n.*, u.username as author_name, u.pen_name, u.email as author_email
FROM novel n
LEFT JOIN user u ON (n.author = u.pen_name OR n.author = u.username)
WHERE n.id = ?
```

#### 3.1.4 审批小说
```
POST /api/admin/review-novel
Headers: 
  Authorization: Bearer {token}
  Content-Type: application/json
Body: {
  novelId: number,
  action: 'approve' | 'reject',
  reason?: string  // 可选，拒绝原因
}
Response: {
  success: boolean,
  message: string,
  data: {
    novelId: number,
    status: string
  }
}
```

**业务逻辑**:
- 验证参数完整性（novelId, action必填）
- 验证action值（必须是'approve'或'reject'）
- 状态映射：
  - `approve` → `review_status = 'approved'`
  - `reject` → `review_status = 'locked'`（注意：前端显示为"已拒绝"，但数据库存储为'locked'）
- 更新数据库
- 返回更新后的状态

**SQL更新**:
```sql
UPDATE novel SET review_status = ? WHERE id = ?
```

### 3.2 数据库结构

#### 3.2.1 novel表结构
```sql
CREATE TABLE `novel` (
  `id` int NOT NULL AUTO_INCREMENT,
  `user_id` int DEFAULT NULL COMMENT '作者用户ID',
  `title` varchar(255) NOT NULL,
  `status` varchar(50) DEFAULT NULL,  -- 'ongoing' | 'completed'
  `cover` varchar(255) DEFAULT NULL,
  `rating` int DEFAULT '0',
  `reviews` int DEFAULT '0',
  `author` varchar(100) DEFAULT NULL,
  `translator` varchar(100) DEFAULT NULL,
  `description` text,
  `recommendation` text DEFAULT NULL,
  `languages` varchar(255) DEFAULT NULL,
  `chapters` int DEFAULT '0',
  `licensed_from` varchar(100) DEFAULT NULL,
  `review_status` enum(
    'created',      -- 草稿/已创建（作者新建但未提交审核）
    'submitted',    -- 已提交（提交审核但未开始审核）
    'reviewing',    -- 审核中（平台审核人员正在审核）
    'approved',     -- 审核通过（待上架）
    'published',    -- 已上架（已正式展示给读者）
    'unlisted',     -- 已下架（手动下架但未违规）
    'archived',     -- 已归档（历史作品）
    'locked'        -- 已锁定/违规锁定（违规或版权问题）
  ) DEFAULT 'created',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_review_status` (`review_status`),
  CONSTRAINT `novel_ibfk_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 3.2.2 review_status状态说明

| 状态值 | 中文名称 | 说明 | 前端显示 |
|--------|---------|------|---------|
| created | 草稿/已创建 | 作者新建但未提交审核 | - |
| submitted | 已提交 | 提交审核但未开始审核 | "已提交" |
| reviewing | 审核中 | 平台审核人员正在审核 | "审核中" |
| approved | 审核通过 | 待上架，可由作者或系统选择上架时间 | "已批准" |
| published | 已上架 | 已正式展示给读者，可阅读 | - |
| unlisted | 已下架 | 手动下架但未违规，可以重新上架 | - |
| archived | 已归档 | 历史作品，只保留数据，不再展示 | - |
| locked | 已锁定/违规锁定 | 违规或版权问题，被平台冻结，不能再上架 | "已拒绝" |

**注意**: 前端显示的"已拒绝"对应数据库的`locked`状态，而不是`rejected`状态。

### 3.3 权限验证

所有API端点都使用`authenticateAdmin`中间件进行权限验证：

```javascript
const authenticateAdmin = async (req, res, next) => {
  // 1. 从请求头获取JWT token
  // 2. 验证token有效性
  // 3. 检查用户是否为管理员
  // 4. 将adminId附加到req对象
  // 5. 调用next()继续处理
}
```

### 3.4 错误处理

所有API端点都包含统一的错误处理：
- 参数验证错误：返回400状态码
- 资源不存在：返回404状态码
- 权限错误：返回403状态码
- 服务器错误：返回500状态码，记录错误日志

---

## 四、数据流

### 4.1 加载小说列表流程

```
前端组件加载
  ↓
useEffect触发（filterStatus变化）
  ↓
调用loadNovels()
  ↓
根据filterStatus选择API端点
  ├─ filterStatus === 'all' → GET /admin/pending-novels
  └─ 其他 → GET /admin/novels?status={filterStatus}
  ↓
后端验证token
  ↓
查询数据库
  ↓
返回JSON响应
  ↓
前端更新novels状态
  ↓
React重新渲染列表
```

### 4.2 审批流程

```
用户点击"批准"或"拒绝"
  ↓
显示确认对话框
  ↓
用户确认
  ↓
调用handleReview(novelId, action)
  ↓
POST /admin/review-novel
  Body: { novelId, action }
  ↓
后端验证token和参数
  ↓
更新数据库review_status
  ├─ approve → 'approved'
  └─ reject → 'locked'
  ↓
返回成功响应
  ↓
前端刷新列表（loadNovels()）
  ↓
关闭模态框（如果打开）
  ↓
显示更新后的列表
```

### 4.3 查看详情流程

```
用户点击"查看详情"
  ↓
调用viewNovelDetail(novelId)
  ↓
GET /admin/novel/:id
  ↓
后端查询数据库
  ↓
返回小说详情
  ↓
前端设置selectedNovel状态
  ↓
显示模态框
```

---

## 五、技术特点

### 5.1 前端特点

1. **组件化设计**: 使用React函数组件和Hooks
2. **状态管理**: 使用useState管理本地状态
3. **副作用处理**: 使用useEffect监听状态变化
4. **错误处理**: 统一的错误回调机制（onError prop）
5. **用户体验**: 
   - 加载状态提示
   - 空状态提示
   - 确认对话框防止误操作
   - 按钮禁用状态防止重复提交

### 5.2 后端特点

1. **RESTful API**: 标准的HTTP方法和状态码
2. **权限控制**: JWT token验证
3. **数据库优化**: 
   - 使用索引（idx_review_status）
   - LEFT JOIN优化查询
   - 分页支持
4. **错误处理**: 统一的错误响应格式
5. **安全性**: 
   - SQL注入防护（参数化查询）
   - Token验证
   - 管理员权限检查

### 5.3 状态映射不一致问题

**问题**: 前端显示的"已拒绝"对应数据库的`locked`状态，而不是`rejected`状态。

**原因**: 数据库schema中`review_status`枚举值包含`locked`（违规锁定），但没有`rejected`状态。审批拒绝时，系统将状态设置为`locked`，表示违规锁定。

**影响**: 
- 前端筛选"已拒绝"时，需要查询`review_status = 'locked'`
- 前端状态显示需要将`locked`映射为"已拒绝"

---

## 六、改进建议

1. **状态一致性**: 统一前端显示状态和数据库状态值，或添加状态映射层
2. **拒绝原因**: 当前拒绝操作没有记录原因，建议添加`reason`字段存储拒绝原因
3. **审核历史**: 建议添加审核记录表，记录每次审核操作的时间、操作人、原因等
4. **批量操作**: 支持批量批准/拒绝功能
5. **搜索功能**: 添加按标题、作者搜索功能
6. **排序功能**: 支持按创建时间、标题等排序
7. **审核进度**: 显示审核开始时间、审核时长等统计信息

---

## 七、相关文件清单

### 前端文件
- `frontend/src/pages/AdminPanel/NovelReview/index.tsx` - 主组件
- `frontend/src/pages/AdminPanel/NovelReview/NovelReview.module.css` - 样式文件
- `frontend/src/pages/AdminPanel.tsx` - 父组件（集成）

### 后端文件
- `backend/routes/admin.js` - API路由（第111-288行）
  - GET `/pending-novels` - 获取待审批列表
  - GET `/novels` - 获取筛选列表
  - GET `/novel/:id` - 获取详情
  - POST `/review-novel` - 审批操作

### 数据库文件
- `backend/database_schema.sql` - 数据库schema
- `backend/migrations/004_update_novel_review_status_to_8_states.sql` - 状态枚举定义

---

## 八、API调用示例

### 获取待审批列表
```bash
curl -X GET "http://localhost:5000/api/admin/pending-novels" \
  -H "Authorization: Bearer {token}"
```

### 获取已提交的小说
```bash
curl -X GET "http://localhost:5000/api/admin/novels?status=submitted&page=1&limit=20" \
  -H "Authorization: Bearer {token}"
```

### 审批通过
```bash
curl -X POST "http://localhost:5000/api/admin/review-novel" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"novelId": 1, "action": "approve"}'
```

### 审批拒绝
```bash
curl -X POST "http://localhost:5000/api/admin/review-novel" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"novelId": 1, "action": "reject"}'
```

---

**文档生成时间**: 2025年
**适用版本**: 当前代码库版本

