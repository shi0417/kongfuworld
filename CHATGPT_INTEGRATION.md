# ChatGPT 集成实现文档

## 概述

本项目已成功集成 ChatGPT API，用于自动分析小说章节。当用户上传多个文件时，系统会使用 ChatGPT 来智能分析章节名称和内容，确保章节的准确提取和排序。

## 实现的功能

### 1. 后端 ChatGPT 集成

#### 文件修改：
- `backend/server.js`: 添加了 OpenAI API Key 配置
- `backend/upload_novel.js`: 集成了 ChatGPT 分析功能

#### 主要功能：
1. **API Key 配置**: 使用您的 OpenAI API Key 进行配置
2. **智能章节分析**: 使用 ChatGPT 分析小说内容，自动识别章节标题和内容
3. **多文件处理**: 支持同时处理多个文件，并保持章节顺序
4. **错误处理**: 如果 ChatGPT API 调用失败，自动回退到传统解析方法

#### 新增 API 端点：
- `POST /api/novel/parse-multiple-files`: 使用 ChatGPT 分析多个文件

### 2. 前端集成

#### 文件修改：
- `frontend/src/config.ts`: 添加了新的 API 端点
- `frontend/src/pages/NovelUpload.tsx`: 修改了文件上传逻辑

#### 主要改进：
1. **简化上传流程**: 直接使用 ChatGPT API 进行多文件分析
2. **进度条优化**: 显示 ChatGPT 分析进度
3. **错误处理**: 更好的错误提示和处理

## 技术实现细节

### 1. ChatGPT 分析逻辑

```javascript
async function analyzeChaptersWithGPT(fileName, fileContent) {
  const prompt = `你是一个专业的小说章节分析助手。请仔细分析小说内容，准确区分章节标题和章节内容。区分标题和内容的时候
          要注意，章节标题通常字体会大些，内容字体通常会小些，如果该小说是人尽皆知的小说（根据上传的文件名称或者内容可以判断），那么请
          根据这个小说的标题和内容对照着该上传的小说来区分标题和内容。

重要分析规则：
1. 章节标题识别：
   - 章节标题格式：如"第五回  游幻境指迷十二钗 饮仙醪曲演红楼梦"、"第四回"、"第八十一回"等
   - 章节标题可能是单行或多行，如果标题被换行分割，需要合并为完整标题
   - 例如："第十三回 秦可卿死封龙禁尉" + "王熙凤协理宁国府" = "第十三回 秦可卿死封龙禁尉 王熙凤协理宁国府"
   - 章节标题后面紧跟着的是章节正文内容

2. 红楼梦章节标题参考（用于核对）：
   - 第一回 甄士隐梦幻识通灵 贾雨村风尘怀闺秀
   - 第二回 贾夫人仙逝扬州城 冷子兴演说荣国府
   - 第三回 贾雨村夤缘复旧职 林黛玉抛父进京都
   - 第四回 薄命女偏逢薄命郎 葫芦僧乱判葫芦案
   - 第五回 游幻境指迷十二钗 饮仙醪曲演红楼梦
   - 第六回 贾宝玉初试云雨情 刘姥姥一进荣国府
   - 第七回 送宫花贾琏戏熙凤 宴宁府宝玉会秦钟
   - 第八回 比通灵金莺微露意 探宝钗黛玉半含酸
   - 第九回 恋风流情友入家塾 起嫌疑顽童闹学堂
   - 第十回 金寡妇贪利权受辱 张太医论病细穷源
   - 第十一回 庆寿辰宁府排家宴 见熙凤贾瑞起淫心
   - 第十二回 王熙凤毒设相思局 贾天祥正照风月鉴
   - 第十三回 秦可卿死封龙禁尉 王熙凤协理宁国府
   - 第十四回 林如海捐馆扬州城 贾宝玉路谒北静王
   - 第十五回 王凤姐弄权铁槛寺 秦鲸卿得趣馒头庵

3. 章节内容识别：
   - 章节内容是从章节标题后面开始，到下一个章节标题之前的所有文字
   - 章节内容不包括章节标题本身
   - 如果正文中有"第四回中既将薛家母子在荣府内寄居等事略已表明，此回则暂不能写矣。"这样的句子，这是章节内容，不是章节标题

4. 关键判断标准：
   - 章节标题：通常是"第X回"或"第X章"开头，后面跟着章节名称
   - 多行标题处理：如果发现"第X回"开头，但后面还有相关的标题内容，应该合并为完整标题
   - 章节内容：包含具体的故事内容，如"第四回中既将薛家母子在荣府内寄居等事略已表明，此回则暂不能写矣。如今且说林黛玉自在荣府以来..."

5. 错误示例（不要这样做）：
   - 错误：将"第四回中既将薛家母子在荣府内寄居等事略已表明，此回则暂不能写矣。"作为章节标题
   - 错误：将"第十三回 秦可卿死封龙禁尉"和"王熙凤协理宁国府"分别作为两个章节标题
   - 正确：将"第十三回 秦可卿死封龙禁尉 王熙凤协理宁国府"作为完整的章节标题
   - 正确：章节标题应该是独立的、格式化的标题行

6. 输出要求：
   - 每个章节的title字段只包含完整的章节标题（如"第十三回 秦可卿死封龙禁尉 王熙凤协理宁国府"）
   - 每个章节的content字段包含该章节的完整正文内容
   - 保持章节的原始顺序
  `;
  
  const response = await openai.chat.completions.create({
    model: 'gpt-3.5-turbo',
    messages: [{ role: 'user', content: prompt }],
    temperature: 0.2,
    max_tokens: 2000,
  });
}
```

### 2. 多文件处理流程

1. 用户选择多个文件
2. 前端按用户选择的排序方式对文件进行排序
3. 将所有文件发送到后端
4. 后端使用 ChatGPT 逐个分析每个文件
5. 合并所有章节并按顺序排序
6. 返回处理结果给前端

### 3. 错误处理和回退机制

- 如果 ChatGPT API 调用失败，自动使用传统解析方法
- 如果单个文件解析失败，继续处理其他文件
- 提供详细的错误信息和进度反馈

## 使用方法

### 1. 上传文件
1. 在小说上传页面选择多个文件（支持 .docx, .pdf, .txt）
2. 选择文件排序方式（按名称、大小、日期）
3. 点击上传按钮

### 2. ChatGPT 分析
1. 系统会自动使用 ChatGPT 分析每个文件
2. 进度条会显示分析进度
3. 分析完成后会显示找到的章节列表

### 3. 章节管理
1. 可以查看和编辑章节标题
2. 可以调整章节设置（锁定、VIP、高级等）
3. 可以设置章节范围

## 配置要求

### 1. OpenAI API Key
- 需要在 `backend/server.js` 中配置有效的 OpenAI API Key
- 确保 API Key 有足够的配额

### 2. 依赖包
- `openai@5.10.2`: 用于 ChatGPT API 调用
- 其他现有依赖保持不变

## 测试验证

### 1. API 测试
- 创建了 `backend/test_chatgpt_integration.js` 测试脚本
- 验证 ChatGPT API 调用是否正常

### 2. 集成测试
- 服务器启动测试：确认 OpenAI API 配置成功
- 多文件上传测试：验证完整的处理流程

## 注意事项

1. **API 配额**: 注意 OpenAI API 的使用配额，避免超出限制
2. **文件大小**: 建议限制单个文件大小，避免 token 超限
3. **错误处理**: 系统会自动回退到传统方法，确保功能可用性
4. **性能优化**: 对于大文件，只分析前 3000 字符以提高效率

## 未来改进

1. **缓存机制**: 可以添加结果缓存，避免重复分析
2. **批量处理**: 优化多文件批量处理性能
3. **自定义提示**: 允许用户自定义 ChatGPT 分析提示
4. **结果验证**: 添加更严格的结果验证机制

## 总结

ChatGPT 集成已成功实现，能够：
- 智能分析小说章节
- 自动识别章节标题和内容
- 支持多文件上传和处理
- 提供友好的用户界面和进度反馈
- 具备完善的错误处理和回退机制

该功能大大提升了小说上传的智能化程度，减少了手动编辑的工作量。 