# 结算总览 & 编辑结算功能现状梳理（仅分析，不改动）

**分析时间**：2025-12-01  
**分析目标**：为后续增加"编辑每月结算"选项卡做准备，完整摸清现有"结算总览"功能的实现

---

## 一、前端页面与组件结构

### 1.1 核心文件位置

**主组件文件**：`frontend/src/pages/AdminPanel.tsx`

**组件名称**：`AdminPanel`（React函数组件）

**当前布局**：**单页布局，未使用 Tabs 组件**。通过 `activeTab` 状态变量控制不同功能模块的显示，使用条件渲染（`{activeTab === 'settlement-overview' && ...}`）切换内容。

### 1.2 结算总览页面结构

**Tab 标识**：`activeTab === 'settlement-overview'`

**页面位置**：在左侧导航栏的"收益与编辑管理"分组下，作为子菜单项显示。

**页面结构**：
- **标题**：`<h2>结算总览</h2>`
- **筛选栏**：
  - 月份选择器（`<input type="month">`）
  - 状态筛选下拉框（全部状态/未支付/已支付）
  - 角色筛选下拉框（全部用户/仅作者/仅推广者）
  - 用户ID输入框
  - "查询"按钮
  - "生成月度汇总"按钮
- **表格区域**：`<div className={styles.paymentTable}>`

### 1.3 表格组件与字段定义

**表格组件**：使用原生 HTML `<table>` 标签，非第三方组件库。

**表格标题**：`用户结算列表（作者+推广者）(user_income_monthly)`

**表格列定义**：

| 列名（显示） | 数据字段名 | 数据类型 | 说明 |
|------------|-----------|---------|------|
| 用户 | `pen_name` / `username` / `用户${user_id}` | string | 优先显示笔名，其次用户名 |
| 作者作品收入(USD) | `month_author_base_income` | number | 来自 `user_income_monthly.author_base_income_usd` |
| 读者推广收入(USD) | `month_reader_referral_income` | number | 来自 `user_income_monthly.reader_referral_income_usd` |
| 作者推广收入(USD) | `month_author_referral_income` | number | 来自 `user_income_monthly.author_referral_income_usd` |
| 当月总收入(USD) | `month_total_income` | number | 来自 `user_income_monthly.total_income_usd` |
| 支付状态 | `month_status` | enum | 'unpaid' / 'paid' / 'processing' / 'failed' |
| 支付方式 | `payout_method` | string | 'paypal' / 'alipay' / 'wechat' / 'bank_transfer' |
| 支付币种 | `payout_currency` | string | 'USD' / 'CNY' |
| 支付金额 | `payout_amount` | number | 实际支付金额（含币种） |
| 操作 | - | - | "发起支付"按钮 |

**表格行交互**：
- 点击行可展开/折叠查看支付详情
- 支付状态列可点击查看详情（仅已支付状态）
- 支付方式列可点击同步PayPal状态（仅PayPal方式）

### 1.4 事件处理函数

#### 1.4.1 查询列表

**函数名**：`loadSettlementOverview`

**调用API**：`GET /api/admin/user-settlement/overview`

**请求参数**：
- `month`：结算月份（格式：`YYYY-MM`，如 `2025-10`）
- `status`：支付状态筛选（可选：`all` / `unpaid` / `paid`）
- `role`：角色筛选（可选：`all` / `author_only` / `promoter_only`）
- `userId`：用户ID筛选（可选）

**返回数据结构**：
```typescript
{
  success: boolean;
  data: Array<{
    user_id: number;
    username: string;
    pen_name: string;
    email: string;
    is_author: boolean;
    is_promoter: boolean;
    month_author_base_income: number;
    month_reader_referral_income: number;
    month_author_referral_income: number;
    month_total_income: number;
    month_paid_amount: number;
    month_unpaid_amount: number;
    month_status: string; // 'unpaid' | 'paid' | 'processing' | 'failed'
    total_unpaid_amount: number;
    income_monthly_id: number | null;
    payout_id: number | null;
    payout_method: string | null;
    payout_currency: string | null;
    payout_amount: number | null;
  }>;
}
```

#### 1.4.2 生成月度汇总

**函数名**：`generateMonthlyIncome`

**调用API**：`POST /api/admin/user-settlement/generate-monthly`

**请求参数**：
```json
{
  "month": "2025-10-01"  // 格式：YYYY-MM-01
}
```

**返回数据结构**：
```typescript
{
  success: boolean;
  message: string;
}
```

#### 1.4.3 发起支付

**函数名**：`initiatePayment`

**调用API**：`POST /api/admin/settlements/:incomeMonthlyId/pay`

**请求参数**：
```json
{
  "account_id": number,
  "method": string,  // 'paypal' | 'alipay' | 'wechat' | 'bank_transfer'
  "payout_currency": string,  // 'USD' | 'CNY'
  "fx_rate": string,  // 汇率，USD时为"1.0"
  "note": string  // 备注（可选）
}
```

**返回数据结构**：
```typescript
{
  success: boolean;
  message: string;
}
```

#### 1.4.4 同步PayPal状态

**函数名**：`syncPayPalStatusByIncomeMonthlyId`

**调用API**：`POST /api/admin/settlements/:incomeMonthlyId/sync-paypal`

**请求参数**：无（通过URL参数传递 `incomeMonthlyId`）

**返回数据结构**：
```typescript
{
  success: boolean;
  message: string;
}
```

#### 1.4.5 查看结算详情

**函数名**：`loadSettlementDetail` / `toggleRowExpansion`

**调用API**：`GET /api/admin/settlements/:incomeMonthlyId/detail`

**返回数据结构**：
```typescript
{
  success: boolean;
  data: {
    income_monthly: {...},  // user_income_monthly 记录
    user: {...},  // user 基本信息
    payouts: Array<{...}>,  // user_payout 记录数组
    gateway_transactions: Array<{...}>  // payout_gateway_transaction 记录数组
  };
}
```

### 1.5 前端使用的所有后端接口汇总

| 接口路径 | HTTP方法 | 用途 | 请求参数 | 关键返回字段 |
|---------|---------|------|---------|------------|
| `/api/admin/user-settlement/overview` | GET | 查询结算总览列表 | `month`, `status`, `role`, `userId` | `data[]`（用户列表） |
| `/api/admin/user-settlement/generate-monthly` | POST | 生成月度汇总 | `{month: string}` | `success`, `message` |
| `/api/admin/settlements/:incomeMonthlyId/pay` | POST | 发起支付 | `{account_id, method, payout_currency, fx_rate, note}` | `success`, `message` |
| `/api/admin/settlements/:incomeMonthlyId/sync-paypal` | POST | 同步PayPal状态 | 无 | `success`, `message` |
| `/api/admin/settlements/:incomeMonthlyId/detail` | GET | 查看结算详情 | 无 | `data`（详情对象） |
| `/api/admin/user-settlement/detail/:userId` | GET | 获取用户结算详情（用于发起支付时加载账户信息） | `months`（查询月数） | `data`（用户详情） |

---

## 二、后端接口与 Service 现状梳理

### 2.1 路由文件位置

**路由文件**：`backend/routes/admin.js`

**中间件**：所有接口都使用 `authenticateAdmin` 进行管理员身份验证。

### 2.2 各接口详细说明

#### 2.2.1 GET `/api/admin/user-settlement/overview`

**位置**：`backend/routes/admin.js` 第 4609-4746 行

**实现方式**：直接在路由处理函数中实现，**未使用独立的 Service 层**。

**核心逻辑**：
1. 从 `user` 表查询所有用户
2. LEFT JOIN `user_income_monthly`（按 `user_id` 和 `month` 匹配）
3. LEFT JOIN `user_payout`（通过 `user_income_monthly.payout_id`）
4. 使用子查询判断用户是否为推广者（`commission_transaction` 表）
5. 使用子查询计算累计未支付金额
6. 根据查询参数进行筛选（状态、角色、用户ID）
7. 按 `total_unpaid_amount DESC, user_id ASC` 排序

**查询的主要表**：
- `user`（用户基本信息）
- `user_income_monthly`（月度收入汇总）
- `user_payout`（支付单）
- `commission_transaction`（用于判断是否为推广者）

#### 2.2.2 POST `/api/admin/user-settlement/generate-monthly`

**位置**：`backend/routes/admin.js` 第 6418-6580 行

**实现方式**：直接在路由处理函数中实现，**未使用独立的 Service 层**。

**核心逻辑**：
1. **数据来源**：
   - `author_royalty` 表：获取所有作者的基础收入（`author_id`, `settlement_month`）
   - `commission_transaction` 表：获取所有推广者的推广收入（`user_id`, `settlement_month`, `commission_type`）
2. **聚合计算**：
   - 对每个用户，分别计算：
     - `author_base_income_usd`：从 `author_royalty` 汇总
     - `reader_referral_income_usd`：从 `commission_transaction` 汇总（`commission_type = 'reader_referral'`）
     - `author_referral_income_usd`：从 `commission_transaction` 汇总（`commission_type = 'author_referral'`）
     - `total_income_usd`：三者之和
3. **支付状态判断**：
   - 查询 `user_payout` 表，检查是否有 `status = 'paid'` 的记录
   - 如果有，设置 `payout_status = 'paid'` 和 `payout_id`
   - 否则设置为 `payout_status = 'unpaid'`
4. **写入/更新**：
   - 使用 `INSERT ... ON DUPLICATE KEY UPDATE` 写入 `user_income_monthly` 表
   - 唯一约束：`(user_id, month)`

**涉及的表**：
- `author_royalty`（作者稿费明细）
- `commission_transaction`（推广佣金明细）
- `user_payout`（支付单，用于判断支付状态）
- `user_income_monthly`（目标表）

#### 2.2.3 POST `/api/admin/settlements/:incomeMonthlyId/pay`

**位置**：`backend/routes/admin.js` 第 5090-5650 行

**实现方式**：直接在路由处理函数中实现，**未使用独立的 Service 层**。

**核心逻辑**：
1. **验证**：
   - 检查 `user_income_monthly` 记录是否存在
   - 检查 `payout_status` 是否为 `'paid'`（防止重复支付）
   - 检查是否已有正在处理的支付单
   - 验证收款账户信息（`user_payout_account`）
2. **创建支付单**：
   - 插入 `user_payout` 记录：
     - `user_id`, `month`, `income_monthly_id`
     - `base_amount_usd`（来自 `user_income_monthly.total_income_usd`）
     - `payout_currency`, `payout_amount`, `fx_rate`
     - `method`, `account_info`（JSON格式的账户快照）
     - `status = 'pending'` 或 `'processing'`（PayPal直接发起时为 `'processing'`）
3. **更新收入记录**：
   - 更新 `user_income_monthly.payout_id`
   - 如果支付成功，更新 `payout_status = 'paid'`
4. **调用支付网关**（如果是PayPal）：
   - 创建 `payout_gateway_transaction` 记录
   - 调用PayPal API发起支付
   - 更新 `user_payout.gateway_tx_id`

**涉及的表**：
- `user_income_monthly`（收入记录）
- `user_payout`（支付单）
- `user_payout_account`（收款账户）
- `payout_gateway_transaction`（网关交易记录）

#### 2.2.4 POST `/api/admin/settlements/:incomeMonthlyId/sync-paypal`

**位置**：`backend/routes/admin.js` 第 5667-5960 行

**实现方式**：直接在路由处理函数中实现，**未使用独立的 Service 层**。

**核心逻辑**：
1. 查询 `user_income_monthly` 和 `user_payout`
2. 调用PayPal API查询支付状态
3. 根据PayPal返回的状态更新：
   - `user_payout.status`
   - `payout_gateway_transaction.status`
   - `user_income_monthly.payout_status`

#### 2.2.5 GET `/api/admin/settlements/:incomeMonthlyId/detail`

**位置**：`backend/routes/admin.js` 第 5963-6415 行

**实现方式**：直接在路由处理函数中实现，**未使用独立的 Service 层**。

**核心逻辑**：
1. 查询 `user_income_monthly` 记录
2. 查询 `user` 基本信息
3. 查询 `user_payout` 记录（通过 `payout_id`）
4. 查询 `payout_gateway_transaction` 记录（通过 `gateway_tx_id`）
5. 组装返回数据

### 2.3 Service 层现状

**重要发现**：**当前实现没有独立的 Service 层**，所有业务逻辑都直接在路由处理函数中实现。

**影响**：如果要实现"编辑每月结算"，需要：
- 要么继续在路由中实现（代码重复）
- 要么抽取 Service 层（需要重构现有代码）

---

## 三、与结算相关的数据库表结构摘要

### 3.1 `user_income_monthly`（用户月度收入汇总表）

**用途**：存储用户（作者+推广者）每月的收入汇总和支付状态。

**关键字段**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | BIGINT | 主键 |
| `user_id` | BIGINT | 用户ID（作者或推广者） |
| `month` | DATE | 结算月份（格式：`2025-10-01`） |
| `author_base_income_usd` | DECIMAL(10,6) | 作者基础稿费 |
| `reader_referral_income_usd` | DECIMAL(10,6) | 读者推广收入 |
| `author_referral_income_usd` | DECIMAL(10,6) | 作者推广收入 |
| `total_income_usd` | DECIMAL(10,6) | 总收入（三者之和） |
| `payout_status` | ENUM('unpaid','paid') | 支付状态 |
| `payout_id` | BIGINT | 对应 `user_payout.id`（可为NULL） |
| `created_at` | DATETIME | 创建时间 |
| `updated_at` | DATETIME | 更新时间 |

**索引与约束**：
- **唯一约束**：`UNIQUE KEY uniq_user_month (user_id, month)` - 一个用户一个月只能有一条记录
- **索引**：`idx_user (user_id)`, `idx_month (month)`, `idx_status (payout_status)`

**数据来源**：
- `author_base_income_usd`：从 `author_royalty` 表汇总（`author_id`, `settlement_month`）
- `reader_referral_income_usd`：从 `commission_transaction` 表汇总（`user_id`, `settlement_month`, `commission_type = 'reader_referral'`）
- `author_referral_income_usd`：从 `commission_transaction` 表汇总（`user_id`, `settlement_month`, `commission_type = 'author_referral'`）

### 3.2 `user_payout`（用户支付单主表）

**用途**：存储用户的实际打款记录。

**关键字段**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | BIGINT | 主键 |
| `user_id` | BIGINT | 用户ID |
| `month` | DATE | 对应月份（格式：`2025-10-01`） |
| `income_monthly_id` | BIGINT | 指向 `user_income_monthly.id` |
| `base_amount_usd` | DECIMAL(10,6) | 该月美元收入（记账基准） |
| `payout_currency` | CHAR(3) | 实际支付币种（'USD' 或 'CNY'） |
| `payout_amount` | DECIMAL(10,2) | 实际支付金额（按汇率换算后） |
| `fx_rate` | DECIMAL(12,6) | 汇率（1 USD = fx_rate * payout_currency） |
| `method` | ENUM | 支付方式（'paypal', 'bank_transfer', 'alipay', 'wechat', 'manual'） |
| `status` | ENUM | 状态（'pending', 'processing', 'paid', 'failed', 'cancelled'） |
| `account_info` | JSON | 收款账号快照 |
| `gateway_tx_id` | BIGINT | 对应 `payout_gateway_transaction.id` |
| `requested_at` | DATETIME | 申请时间 |
| `paid_at` | DATETIME | 支付完成时间 |
| `admin_id` | BIGINT | 操作管理员ID |
| `note` | VARCHAR(255) | 备注 |

**索引与约束**：
- **唯一约束**：`UNIQUE KEY uniq_user_month_payout (user_id, month)` - 一个用户一个月只能有一笔支付单
- **索引**：`idx_user (user_id)`, `idx_status (status)`, `idx_method (method)`, `idx_gateway_tx (gateway_tx_id)`

### 3.3 `payout_gateway_transaction`（支付网关交易表）

**用途**：存储第三方支付网关（PayPal、支付宝等）返回的交易记录。

**关键字段**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | BIGINT | 主键 |
| `provider` | ENUM | 支付渠道（'paypal', 'stripe', 'alipay', 'wechat', 'bank_manual'） |
| `provider_tx_id` | VARCHAR(128) | 第三方返回的交易号 |
| `provider_batch_id` | VARCHAR(128) | 批次号（如PayPal Payouts batch id） |
| `status` | ENUM | 状态（'created', 'processing', 'succeeded', 'failed'） |
| `amount_usd` | DECIMAL(10,6) | 金额（USD） |
| `currency` | CHAR(3) | 货币 |
| `base_amount_usd` | DECIMAL(10,6) | 记账美元金额 |
| `payout_currency` | CHAR(3) | 实际支付币种 |
| `payout_amount` | DECIMAL(10,2) | 实际支付金额 |
| `fx_rate` | DECIMAL(12,6) | 汇率 |
| `request_payload` | JSON | 请求报文快照 |
| `response_payload` | JSON | 响应报文 |
| `callback_payload` | JSON | Webhook回调数据 |
| `error_code` | VARCHAR(64) | 错误码 |
| `error_message` | VARCHAR(255) | 错误信息 |

**索引**：`idx_provider (provider)`, `idx_provider_tx (provider_tx_id)`, `idx_status (status)`

### 3.4 `editor_income_monthly`（编辑基础收入月度表）

**用途**：存储编辑/主编的基础收入明细（从 `reader_spending` 计算得出）。

**关键字段**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | INT | 主键 |
| `editor_admin_id` | INT | 编辑/主编管理员ID |
| `role` | ENUM | 角色（'chief_editor', 'editor', 'proofreader'） |
| `novel_id` | INT | 小说ID |
| `month` | DATE | 结算月份（格式：`2025-10-01`） |
| `source_spend_id` | BIGINT | 对应 `reader_spending.id` |
| `source_type` | ENUM | 收入来源类型（'chapter_unlock', 'subscription', 'mixed'） |
| `chapter_id` | INT | 对应章节ID（`source_type = 'chapter_unlock'` 时使用） |
| `chapter_count_total` | INT | 总章节数（订阅分配时用） |
| `chapter_count_editor` | INT | 该编辑审核的章节数 |
| `total_word_count` | INT | 总字数 |
| `editor_word_count` | INT | 该编辑负责的字数 |
| `gross_book_income_usd` | DECIMAL(18,6) | 小说总收入（USD） |
| `editor_share_percent` | DECIMAL(8,4) | 编辑分成比例（实际生效比例） |
| `contract_share_percent` | DECIMAL(8,4) | 合同基础分成比例 |
| `editor_income_usd` | DECIMAL(18,6) | 编辑收入（USD） |
| `created_at` | DATETIME | 创建时间 |
| `updated_at` | DATETIME | 更新时间 |

**索引**：
- `idx_editor_admin_id (editor_admin_id)`
- `idx_novel_id (novel_id)`
- `idx_month (month)`
- `idx_month_source_spend (month, source_spend_id)`
- `idx_source_spend_id (source_spend_id)`
- `idx_chapter_id (chapter_id)`

**重要约束**：
- **已删除唯一约束**：原 `UNIQUE KEY uniq_editor_month_novel (editor_admin_id, novel_id, month)` 已被删除
- **允许同一编辑+小说+月份有多条记录**（因为一条 `reader_spending` 对应一条 `editor_income_monthly`）

**⚠️ 关键发现**：
- **没有支付状态字段**：`editor_income_monthly` 表**没有** `payout_status`、`payout_id` 等支付相关字段
- **没有支付单表**：**没有** `editor_payout` 表用于存储编辑的支付记录

### 3.5 其他相关表

#### `user_payout_account`（用户收款账户配置表）

**用途**：存储用户的收款账户信息（PayPal、支付宝、微信、银行转账等）。

**关键字段**：
- `id`, `user_id`, `method`, `is_default`, `account_label`, `account_data` (JSON)

**注意**：此表是**用户**的收款账户。

#### `admin_payout_account`（管理员/编辑收款账户配置表）

**用途**：存储管理员/编辑的收款账户信息（PayPal、支付宝、微信、银行转账等）。

**关键字段**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | BIGINT | 主键 |
| `admin_id` | INT | 管理员ID（指向 `admin.id`） |
| `method` | ENUM | 收款方式（'paypal', 'bank_transfer', 'alipay', 'wechat'） |
| `is_default` | TINYINT | 是否默认账户 |
| `account_label` | VARCHAR(100) | 显示名（如 "我的PayPal"） |
| `account_data` | JSON | 具体账户信息（结构和 `user_payout_account.account_data` 保持一致） |
| `status` | ENUM | 状态（'active', 'disabled'） |
| `created_at` | DATETIME | 创建时间 |
| `updated_at` | DATETIME | 更新时间 |

**索引**：
- `idx_admin (admin_id)`
- `idx_method (method)`
- **外键**：`fk_admin_payout_account_admin` 指向 `admin(id)`

**重要发现**：**`admin_payout_account` 表已存在**，可以直接用于编辑结算功能。

---

## 四、现有"按用户结算"的计算流程简图

### 4.1 数据生成流程

```
1. 管理员点击"生成月度汇总"按钮
   ↓
2. 前端调用 POST /api/admin/user-settlement/generate-monthly
   ↓
3. 后端处理：
   a. 从 author_royalty 表查询所有作者的基础收入
      - 条件：settlement_month = 指定月份
      - 聚合：按 author_id 分组，SUM(author_amount_usd)
   ↓
   b. 从 commission_transaction 表查询所有推广收入
      - 条件：settlement_month = 指定月份
      - 聚合：按 user_id, commission_type 分组
        - reader_referral: SUM(commission_amount_usd)
        - author_referral: SUM(commission_amount_usd)
   ↓
   c. 合并所有用户ID（去重）
   ↓
   d. 对每个用户：
      - 计算 author_base_income_usd
      - 计算 reader_referral_income_usd
      - 计算 author_referral_income_usd
      - 计算 total_income_usd = 三者之和
      - 查询 user_payout 判断支付状态
      - INSERT/UPDATE user_income_monthly
   ↓
4. 返回成功消息
```

### 4.2 支付流程

```
1. 管理员点击"发起支付"按钮
   ↓
2. 前端调用 POST /api/admin/settlements/:incomeMonthlyId/pay
   ↓
3. 后端处理：
   a. 验证 user_income_monthly 记录
   b. 检查支付状态（防止重复支付）
   c. 获取收款账户信息（user_payout_account）
   d. 创建 user_payout 记录
      - status = 'pending' 或 'processing'
      - 记录支付方式、币种、汇率、金额
   ↓
   e. 更新 user_income_monthly
      - payout_id = 新创建的 user_payout.id
   ↓
   f. 如果是PayPal：
      - 创建 payout_gateway_transaction 记录
      - 调用PayPal API发起支付
      - 更新 user_payout.gateway_tx_id
   ↓
4. 返回成功消息
```

### 4.3 支付状态同步流程

```
1. 管理员点击"同步PayPal状态"
   ↓
2. 前端调用 POST /api/admin/settlements/:incomeMonthlyId/sync-paypal
   ↓
3. 后端处理：
   a. 查询 user_income_monthly 和 user_payout
   b. 调用PayPal API查询支付状态
   c. 根据PayPal返回更新：
      - user_payout.status
      - payout_gateway_transaction.status
      - user_income_monthly.payout_status
   ↓
4. 返回成功消息
```

---

## 五、为"编辑每月结算"可复用的部分

### 5.1 前端 UI 组件可复用部分

#### ✅ 可直接复用

1. **表格结构**：
   - 表格的 HTML 结构和样式（`styles.paymentTable`）
   - 列定义逻辑（可以修改列名和字段）

2. **筛选栏组件**：
   - 月份选择器
   - 状态筛选下拉框
   - "查询"按钮
   - "生成月度汇总"按钮

3. **支付相关组件**：
   - "发起支付"按钮
   - 支付详情弹窗（需要修改数据源）
   - PayPal状态同步功能

4. **行展开/折叠功能**：
   - `toggleRowExpansion` 函数逻辑
   - 展开/折叠的UI样式

#### ⚠️ 需要修改

1. **表格列定义**：
   - 需要将"作者作品收入"改为"编辑基础收入"
   - 需要移除"读者推广收入"和"作者推广收入"列
   - 可能需要添加"角色"列（editor/chief_editor）
   - 可能需要添加"小说数"列（统计该编辑负责的小说数量）

2. **角色筛选**：
   - 需要将"全部用户/仅作者/仅推广者"改为"全部角色/仅编辑/仅主编"

3. **用户信息显示**：
   - 需要从 `admin` 表获取编辑信息（而非 `user` 表）
   - 显示字段：`admin.username` 或 `admin.name`

### 5.2 后端接口可复用部分

#### ✅ 可直接复用（需要修改数据源）

1. **查询列表接口**：
   - 可以复制 `GET /api/admin/user-settlement/overview` 的逻辑
   - 修改为：
     - 从 `admin` 表查询（而非 `user`）
     - 从 `editor_income_monthly` 表聚合（而非 `user_income_monthly`）
     - 按 `editor_admin_id` + `month` 分组
     - 可能需要按 `role` 区分（editor/chief_editor）

2. **生成月度汇总接口**：
   - 可以复制 `POST /api/admin/user-settlement/generate-monthly` 的逻辑
   - 修改为：
     - 从 `editor_income_monthly` 表聚合（而非从 `author_royalty` 和 `commission_transaction`）
     - 按 `editor_admin_id` + `month` + `role` 分组
     - 写入新的 `editor_settlement_monthly` 表（需要新建）

3. **发起支付接口**：
   - 可以复制 `POST /api/admin/settlements/:incomeMonthlyId/pay` 的逻辑
   - 修改为：
     - 操作 `editor_settlement_monthly` 表（而非 `user_income_monthly`）
     - 创建 `editor_payout` 记录（需要新建表）
     - 其他逻辑基本相同

4. **同步PayPal状态接口**：
   - 可以完全复用 `POST /api/admin/settlements/:incomeMonthlyId/sync-paypal` 的逻辑
   - 只需要修改表名

5. **查看结算详情接口**：
   - 可以复制 `GET /api/admin/settlements/:incomeMonthlyId/detail` 的逻辑
   - 修改为查询编辑相关的表

#### ⚠️ 需要新建

1. **编辑结算汇总表**（建议名称：`editor_settlement_monthly`）：
   - 类似 `user_income_monthly` 的结构
   - 字段：`editor_admin_id`, `role`, `month`, `total_income_usd`, `payout_status`, `payout_id` 等

2. **编辑支付单表**（建议名称：`editor_payout`）：
   - 类似 `user_payout` 的结构
   - 字段：`editor_admin_id`, `month`, `income_monthly_id`, `base_amount_usd`, `payout_currency`, `payout_amount`, `fx_rate`, `method`, `status` 等

3. **编辑收款账户表**：
   - ✅ **已存在**：`admin_payout_account` 表可以直接使用
   - 字段：`admin_id`, `method`, `is_default`, `account_label`, `account_data`, `status`

### 5.3 数据库结构评估

#### ✅ `editor_income_monthly` 当前结构已满足聚合需求

**可以用于聚合的字段**：
- `editor_admin_id`：编辑ID
- `role`：角色（editor/chief_editor）
- `month`：结算月份
- `editor_income_usd`：收入金额
- `novel_id`：小说ID（可用于统计小说数量）

**聚合SQL示例**：
```sql
SELECT 
  editor_admin_id,
  role,
  month,
  SUM(editor_income_usd) as total_income_usd,
  COUNT(DISTINCT novel_id) as novel_count,
  COUNT(*) as record_count
FROM editor_income_monthly
WHERE month = '2025-10-01'
GROUP BY editor_admin_id, role, month
```

#### ❌ 缺少支付相关字段

**需要补充的字段**（建议在新建的 `editor_settlement_monthly` 表中）：

1. **支付状态字段**：
   - `payout_status` ENUM('unpaid', 'paid') DEFAULT 'unpaid'
   - `payout_id` BIGINT NULL（指向 `editor_payout.id`）

2. **其他建议字段**：
   - `created_at`, `updated_at`（时间戳）
   - `id`（主键）

**建议的表结构**：
```sql
CREATE TABLE `editor_settlement_monthly` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `editor_admin_id` INT NOT NULL,
  `role` ENUM('chief_editor', 'editor', 'proofreader') NOT NULL,
  `month` DATE NOT NULL,
  `total_income_usd` DECIMAL(18,6) NOT NULL DEFAULT 0,
  `novel_count` INT NOT NULL DEFAULT 0 COMMENT '负责的小说数量',
  `record_count` INT NOT NULL DEFAULT 0 COMMENT '收入记录条数',
  `payout_status` ENUM('unpaid', 'paid') NOT NULL DEFAULT 'unpaid',
  `payout_id` BIGINT NULL,
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uniq_editor_role_month` (`editor_admin_id`, `role`, `month`),
  KEY `idx_editor` (`editor_admin_id`),
  KEY `idx_month` (`month`),
  KEY `idx_status` (`payout_status`)
);
```

**建议的支付单表结构**：
```sql
CREATE TABLE `editor_payout` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `editor_admin_id` INT NOT NULL,
  `role` ENUM('chief_editor', 'editor', 'proofreader') NOT NULL,
  `month` DATE NOT NULL,
  `income_monthly_id` BIGINT NOT NULL,
  `base_amount_usd` DECIMAL(18,6) NOT NULL,
  `payout_currency` CHAR(3) NOT NULL,
  `payout_amount` DECIMAL(10,2) NOT NULL,
  `fx_rate` DECIMAL(12,6) NOT NULL,
  `method` ENUM('paypal', 'bank_transfer', 'alipay', 'wechat', 'manual') NOT NULL,
  `status` ENUM('pending', 'processing', 'paid', 'failed', 'cancelled') NOT NULL DEFAULT 'pending',
  `account_info` JSON NULL,
  `gateway_tx_id` BIGINT NULL,
  `requested_at` DATETIME NOT NULL,
  `paid_at` DATETIME NULL,
  `admin_id` BIGINT NULL,
  `note` VARCHAR(255) NULL,
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uniq_editor_role_month_payout` (`editor_admin_id`, `role`, `month`),
  KEY `idx_editor` (`editor_admin_id`),
  KEY `idx_status` (`status`),
  KEY `idx_method` (`method`),
  KEY `idx_gateway_tx` (`gateway_tx_id`)
);
```

---

## 六、总结与建议

### 6.1 实现"编辑每月结算"的关键步骤

1. **数据库层面**：
   - 新建 `editor_settlement_monthly` 表（编辑月度结算汇总）
   - 新建 `editor_payout` 表（编辑支付单）
   - 确认 `admin_payout_account` 表是否存在（或新建）

2. **后端接口层面**：
   - 复制并修改 `GET /api/admin/user-settlement/overview` → `GET /api/admin/editor-settlement/overview`
   - 复制并修改 `POST /api/admin/user-settlement/generate-monthly` → `POST /api/admin/editor-settlement/generate-monthly`
   - 复制并修改支付相关接口（pay, sync-paypal, detail）

3. **前端页面层面**：
   - 在 `AdminPanel.tsx` 中添加新的 Tab（`activeTab === 'editor-settlement'`）
   - 复制结算总览的UI代码，修改数据字段和API调用
   - 或者使用 Tabs 组件，在"结算总览"页面内添加"用户结算"和"编辑结算"两个子Tab

### 6.2 代码复用建议

**高复用度**（>80%）：
- 支付流程逻辑（发起支付、同步状态、查看详情）
- 表格UI组件和样式
- 筛选栏组件

**中等复用度**（50-80%）：
- 查询列表接口（需要修改数据源和聚合逻辑）
- 生成月度汇总接口（需要修改数据源）

**低复用度**（<50%）：
- 表格列定义（字段完全不同）
- 用户信息显示（从 `user` 改为 `admin`）

### 6.3 注意事项

1. **Service 层缺失**：当前实现没有独立的 Service 层，建议在实现"编辑结算"时考虑抽取公共逻辑。

2. **唯一约束**：`editor_settlement_monthly` 需要考虑是否按 `(editor_admin_id, role, month)` 作为唯一约束（因为一个编辑可能同时是 editor 和 chief_editor）。

3. **收款账户**：✅ **已确认**：编辑的收款账户存储在 `admin_payout_account` 表中，可以直接使用。

4. **前端Tab组织**：建议在"结算总览"页面内使用 Tabs 组件，分为"用户结算"和"编辑结算"两个Tab，而不是创建独立的页面。

---

**分析完成**

