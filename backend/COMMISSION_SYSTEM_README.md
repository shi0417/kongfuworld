# 分成系统使用说明

## 概述

本系统实现了完整的多级推广分成和收入统计功能，包括：
- 读者推广分成（多级，可配置比例）
- 作者基础收入（作品收入的50%）
- 作者推广分成（多级，可配置比例）
- 按月统计收入明细

## 数据库表结构

### 1. 核心表

#### referrals（推荐关系表）
- 存储用户之间的推荐关系
- 支持读者推广和作者推广两种方案绑定

#### commission_plan（分成方案主表）
- 存储分成方案配置
- 支持读者推广和作者推广两种类型
- 支持最大层级配置（max_level）

#### commission_plan_level（分成方案层级比例表）
- 存储每个层级的提成比例
- 例如：8%/3%/2% 或 5%/3%/2%

#### karma_dollars（Karma转美元换算表）
- 存储Karma与美元的汇率
- 支持历史汇率查询（按时间生效）

#### reader_spending（读者消费汇总表）
- 统一存储所有读者消费（章节解锁+订阅）
- 金额统一转换为美元

#### author_royalty（作者基础收入表）
- 存储作者的基础稿费收入
- 从读者消费中计算（默认50%）

#### commission_transaction（推广佣金明细表）
- 存储所有推广佣金明细
- 包括读者推广和作者推广

## 安装步骤

### 1. 创建数据库表

```bash
mysql -u root -p123456 kongfuworld < backend/create_commission_system_tables.sql
```

或者直接在MySQL中执行SQL文件内容。

### 2. 默认配置

系统会自动创建：
- **读者推广方案**：8%/3%/2%（3层）
- **作者推广方案**：5%/3%/2%（3层）
- **Karma汇率**：1 karma = 0.01 美元（可调整）

## 使用说明

### 后台管理界面

访问：`http://localhost:3000/admin`

登录后，左侧导航栏包含4个选项卡：
1. **小说审批** - 审批待审核的小说
2. **费用统计** - 查看支付统计
3. **作者收入统计** - 查看作者收入明细
4. **读者收入统计** - 查看读者推广收入明细

### 作者收入统计

1. 选择月份（格式：YYYY-MM）
2. 点击"查询"按钮
3. 查看以下信息：
   - **作者收入汇总**：每个作者的基础收入、推广收入、总收入
   - **作者基础收入明细**：每笔读者消费对应的作者收入
   - **作者推广佣金明细**：多级推广的佣金分配

### 读者收入统计

1. 选择月份（格式：YYYY-MM）
2. 点击"查询"按钮
3. 查看以下信息：
   - **读者推广收入汇总**：每个推广人的总收入
   - **读者消费汇总**：每个读者的消费总额
   - **读者推广佣金明细**：多级推广的佣金分配

## API接口

### 作者收入统计
```
GET /api/admin/author-income-stats?month=2025-10&userId=1
```

参数：
- `month`（必需）：月份，格式 YYYY-MM
- `userId`（可选）：指定用户ID

### 读者收入统计
```
GET /api/admin/reader-income-stats?month=2025-10&userId=1
```

参数：
- `month`（必需）：月份，格式 YYYY-MM
- `userId`（可选）：指定用户ID

## 分成逻辑说明

### 读者推广分成

链：A → B → C → D → E → F

A的收入 = B的消费总额 × 8%（1级）+ C的消费总额 × 3%（2级）+ D的消费总额 × 2%（3级）

### 作者收入

1. **基础收入**：作品收入的50%
2. **推广收入**：多级推广分成

链：J → K → L → M → N → O

J的收入 = K的作品收入 × 5%（1级）+ L的作品收入 × 3%（2级）+ M的作品收入 × 2%（3级）

### 数据来源

- **章节解锁**：从 `chapter_unlocks` 表获取，`unlock_method='karma' AND cost>0`
- **订阅消费**：从 `user_champion_subscription_record` 表获取

## 月度结算流程

系统需要定期执行月度结算，将原始消费数据转换为收入记录：

1. **汇总读者消费** → `reader_spending`
   - 章节解锁：Karma数量 × 当时汇率 → 美元
   - 订阅：直接使用美元金额

2. **计算作者基础收入** → `author_royalty`
   - 从 `reader_spending` 计算，默认50%

3. **计算推广佣金** → `commission_transaction`
   - 沿推荐链向上计算多级分成
   - 使用绑定的分成方案

## 自定义分成方案

### 创建新方案

```sql
-- 创建新的读者推广方案（例如：6%/2%/1%）
INSERT INTO commission_plan (name, plan_type, max_level, start_date) 
VALUES ('2026 Reader 6/2/1', 'reader_promoter', 3, '2026-01-01');

SET @plan_id = LAST_INSERT_ID();

INSERT INTO commission_plan_level (plan_id, level, percent) VALUES
(@plan_id, 1, 0.06),
(@plan_id, 2, 0.02),
(@plan_id, 3, 0.01);
```

### 绑定到推荐关系

```sql
-- 将新方案绑定到新的推荐关系
UPDATE referrals 
SET promoter_plan_id = @plan_id 
WHERE user_id = :new_user_id;
```

**重要**：已绑定的推荐关系会保持原有方案，新方案只影响新的推荐关系。

## 注意事项

1. **数据结算**：需要定期运行结算脚本，将原始数据转换为收入记录
2. **汇率调整**：调整Karma汇率时，历史数据使用历史汇率，新数据使用新汇率
3. **方案锁定**：推荐关系一旦绑定方案，不会自动更新，需要手动调整
4. **防重复结算**：`reader_spending.settled` 字段用于防止重复结算

## 后续开发

需要实现：
1. **月度结算脚本**：自动将原始消费数据转换为收入记录
2. **实时计算**：在消费发生时实时计算分成
3. **提现功能**：作者和推广人可以申请提现
4. **报表导出**：支持导出Excel报表

