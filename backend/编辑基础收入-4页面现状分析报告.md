# 编辑基础收入-4页面现状分析报告

**生成时间**：2025-11-29  
**分析目标**：为新增「编辑基础收入-4」后台页面做准备，摸清现有代码和数据库结构

---

## 一、相关表结构汇总

### 1.1 editor_income_monthly（编辑收入月度表）

**表结构**：
```sql
CREATE TABLE `editor_income_monthly` (
  `id` int NOT NULL AUTO_INCREMENT,
  `editor_admin_id` int NOT NULL COMMENT '编辑管理员ID（关联admin.id）',
  `novel_id` int NOT NULL COMMENT '小说ID',
  `month` date NOT NULL COMMENT '结算月份（格式：YYYY-MM-01）',
  `gross_book_income_usd` decimal(18,6) DEFAULT '0.000000' COMMENT '作品总收入（美元）',
  `editor_share_percent` decimal(8,4) DEFAULT '0.0000' COMMENT '编辑分成比例',
  `editor_income_usd` decimal(18,6) DEFAULT '0.000000' COMMENT '编辑收入（美元）',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uniq_editor_month_novel` (`editor_admin_id`,`novel_id`,`month`),
  KEY `idx_editor_admin_id` (`editor_admin_id`),
  KEY `idx_novel_id` (`novel_id`),
  KEY `idx_month` (`month`),
  CONSTRAINT `fk_editor_income_admin` FOREIGN KEY (`editor_admin_id`) REFERENCES `admin` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_editor_income_novel` FOREIGN KEY (`novel_id`) REFERENCES `novel` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
```

**关键字段说明**：
- `editor_admin_id`：编辑的管理员ID（关联 `admin.id`）
- `novel_id`：小说ID
- `month`：结算月份（DATE 类型，格式：`2025-11-01`）
- `gross_book_income_usd`：作品总收入（当前仅存储 Champion 收入）
- `editor_share_percent`：编辑分成比例（当前未使用）
- `editor_income_usd`：编辑收入（美元）
- **唯一约束**：`(editor_admin_id, novel_id, month)` - 同一编辑、同一小说、同一月份只能有一条记录

---

### 1.2 reader_spending（读者消费汇总表）

**表结构**：
```sql
CREATE TABLE `reader_spending` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '读者用户ID',
  `novel_id` bigint NOT NULL COMMENT '小说ID',
  `karma_amount` int NOT NULL DEFAULT '0' COMMENT '消费使用的karma数量',
  `amount_usd` decimal(20,8) NOT NULL COMMENT '换算后的美元金额（高精度）',
  `source_type` enum('chapter_unlock','subscription') NOT NULL COMMENT '来源类型',
  `source_id` bigint NOT NULL COMMENT '对应source表ID',
  `spend_time` datetime NOT NULL COMMENT '消费时间',
  `settlement_month` date DEFAULT NULL COMMENT '结算月份',
  `settled` tinyint NOT NULL DEFAULT '0' COMMENT '是否已结算',
  `settled_batch_id` bigint DEFAULT NULL COMMENT '结算批次ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `days` int NOT NULL DEFAULT '0' COMMENT '本条记录对应的服务天数（按自然日计数，Champion 订阅拆分用）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uniq_source_month` (`source_type`,`source_id`,`settlement_month`),
  KEY `idx_user_month` (`user_id`,`settlement_month`),
  KEY `idx_month_settled` (`settlement_month`,`settled`),
  KEY `idx_spend_time` (`spend_time`)
) ENGINE=InnoDB AUTO_INCREMENT=308 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='读者消费汇总表'
```

**关键字段说明**：
- `source_type`：来源类型
  - `'chapter_unlock'`：章节解锁（来自 `chapter_unlocks` 表）
  - `'subscription'`：订阅（来自 `user_champion_subscription_record` 表）
- `source_id`：对应源表的ID
  - `source_type='chapter_unlock'` 时，对应 `chapter_unlocks.id`
  - `source_type='subscription'` 时，对应 `user_champion_subscription_record.id`
- `settlement_month`：结算月份（DATE 类型，格式：`2025-11-01`）
- `amount_usd`：美元金额（高精度 DECIMAL(20,8)）
- `spend_time`：消费时间（用于判断当时生效的合同）
- `days`：服务天数（订阅拆分用）

---

### 1.3 chapter（章节表）

**表结构**：
```sql
CREATE TABLE `chapter` (
  `id` int NOT NULL AUTO_INCREMENT,
  `novel_id` int NOT NULL,
  `volume_id` int NOT NULL,
  `chapter_number` int NOT NULL,
  `title` varchar(255) NOT NULL,
  `content` longtext,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `translator_note` text,
  `is_advance` tinyint(1) DEFAULT '0' COMMENT '是否为预读章节',
  `unlock_price` int DEFAULT '0' COMMENT '解锁所需钥匙数量',
  `word_count` int DEFAULT '0' COMMENT '字数',
  `key_cost` int DEFAULT '1' COMMENT '钥匙解锁成本',
  `unlock_priority` enum('free','key','karma','subscription') DEFAULT 'free',
  `review_status` enum('submitted','reviewing','approved','rejected','draft','pending_chief') DEFAULT 'submitted',
  `editor_admin_id` int DEFAULT NULL COMMENT '负责审核该章节的编辑',
  `chief_editor_admin_id` int DEFAULT NULL COMMENT '最终审核该章节的主编ID',
  `reviewed_at` datetime DEFAULT NULL COMMENT '审核时间',
  `is_released` tinyint(1) DEFAULT '1' COMMENT '是否已发布',
  `release_date` datetime DEFAULT NULL COMMENT '发布日期',
  PRIMARY KEY (`id`),
  KEY `novel_id` (`novel_id`),
  KEY `idx_review_status` (`review_status`),
  KEY `idx_chapter_editor_admin_id` (`editor_admin_id`),
  KEY `idx_chapter_reviewed_at` (`reviewed_at`),
  KEY `idx_chapter_chief_editor_admin_id` (`chief_editor_admin_id`),
  CONSTRAINT `chapter_ibfk_1` FOREIGN KEY (`novel_id`) REFERENCES `novel` (`id`),
  CONSTRAINT `fk_chapter_chief_editor_admin` FOREIGN KEY (`chief_editor_admin_id`) REFERENCES `admin` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_chapter_editor_admin` FOREIGN KEY (`editor_admin_id`) REFERENCES `admin` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB AUTO_INCREMENT=1499 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
```

**关键字段说明**：
- `editor_admin_id`：负责审核该章节的编辑（关联 `admin.id`）
- `chief_editor_admin_id`：最终审核该章节的主编ID（关联 `admin.id`）
- `word_count`：字数（用于按字数比例分配编辑收入）
- `is_released`：是否已发布（`1`=已发布）
- `review_status`：审核状态
- `reviewed_at`：审核时间（用于判断当时生效的合同）

---

### 1.4 novel_editor_contract（小说编辑合同表）

**表结构**：
```sql
CREATE TABLE `novel_editor_contract` (
  `id` int NOT NULL AUTO_INCREMENT,
  `novel_id` int NOT NULL COMMENT '小说ID',
  `editor_admin_id` int NOT NULL COMMENT '编辑管理员ID（关联admin.id）',
  `role` enum('chief_editor','editor','proofreader') DEFAULT 'editor' COMMENT '编辑角色',
  `share_type` enum('percent_of_book','percent_of_author') DEFAULT 'percent_of_book' COMMENT '分成类型',
  `share_percent` decimal(8,4) DEFAULT NULL COMMENT '分成比例（例：0.0300 = 3%）',
  `start_chapter_id` int DEFAULT NULL COMMENT '起始章节ID',
  `end_chapter_id` int DEFAULT NULL COMMENT '结束章节ID',
  `start_date` datetime NOT NULL COMMENT '合同开始时间',
  `end_date` datetime DEFAULT NULL COMMENT '合同结束时间',
  `status` enum('active','ended','cancelled') DEFAULT 'active' COMMENT '合同状态',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_novel_id` (`novel_id`),
  KEY `idx_editor_admin_id` (`editor_admin_id`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_editor_contract_admin` FOREIGN KEY (`editor_admin_id`) REFERENCES `admin` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_editor_contract_novel` FOREIGN KEY (`novel_id`) REFERENCES `novel` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
```

**关键字段说明**：
- `role`：编辑角色
  - `'chief_editor'`：主编
  - `'editor'`：编辑
  - `'proofreader'`：校对
- `share_type`：分成类型
  - `'percent_of_book'`：按作品总收入分成（当前使用）
  - `'percent_of_author'`：按作者收入分成（未使用）
- `share_percent`：分成比例（DECIMAL(8,4)，例如：`0.0300` = 3%）
- `start_date` / `end_date`：合同生效时间范围
- `status`：合同状态（`'active'`=生效中）
- `start_chapter_id` / `end_chapter_id`：合同适用的章节范围（可选）

---

### 1.5 novel（小说表）

**表结构**：
```sql
CREATE TABLE `novel` (
  `id` int NOT NULL AUTO_INCREMENT,
  `user_id` int DEFAULT NULL COMMENT '作者用户ID',
  `current_editor_admin_id` int DEFAULT NULL COMMENT '当前责任编辑',
  `chief_editor_admin_id` int DEFAULT NULL COMMENT '该小说当前主编admin_id',
  `title` varchar(255) NOT NULL,
  `status` varchar(50) DEFAULT NULL,
  `cover` varchar(255) DEFAULT NULL,
  `rating` int DEFAULT '0',
  `reviews` int DEFAULT '0',
  `author` varchar(100) DEFAULT NULL,
  `translator` varchar(100) DEFAULT NULL,
  `description` text,
  `recommendation` text COMMENT '推荐语',
  `languages` varchar(255) DEFAULT NULL,
  `chapters` int DEFAULT '0',
  `licensed_from` varchar(100) DEFAULT NULL,
  `review_status` enum('created','submitted','reviewing','approved','published','unlisted','archived','locked') DEFAULT 'created',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `champion_status` enum('submitted','invalid','approved','rejected') NOT NULL DEFAULT 'invalid',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_review_status` (`review_status`),
  KEY `fk_novel_current_editor` (`current_editor_admin_id`),
  KEY `idx_novel_chief_editor_admin_id` (`chief_editor_admin_id`),
  CONSTRAINT `fk_novel_chief_editor` FOREIGN KEY (`chief_editor_admin_id`) REFERENCES `admin` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_novel_current_editor` FOREIGN KEY (`current_editor_admin_id`) REFERENCES `admin` (`id`) ON DELETE SET NULL,
  CONSTRAINT `novel_ibfk_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
```

**关键字段说明**：
- `id`：小说ID
- `user_id`：作者用户ID（关联 `user.id`）
- `current_editor_admin_id`：当前责任编辑（关联 `admin.id`）
- `chief_editor_admin_id`：当前主编（关联 `admin.id`）
- `title`：小说标题

---

### 1.6 admin（管理员表）

**表结构**：
```sql
CREATE TABLE `admin` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(100) NOT NULL COMMENT '管理员用户名',
  `email` varchar(255) DEFAULT NULL COMMENT '管理员邮箱',
  `phone` varchar(50) DEFAULT NULL COMMENT '手机号',
  `real_name` varchar(100) DEFAULT NULL COMMENT '真实姓名，用于结算实名',
  `password` varchar(255) NOT NULL COMMENT '密码',
  `level` int DEFAULT '1' COMMENT '管理员级别',
  `role` enum('super_admin','chief_editor','editor','finance','operator') DEFAULT 'editor' COMMENT '角色',
  `status` tinyint(1) DEFAULT '1' COMMENT '状态',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `name` (`name`),
  UNIQUE KEY `uniq_admin_email` (`email`),
  KEY `idx_role` (`role`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
```

**关键字段说明**：
- `id`：管理员ID（编辑/主编的ID）
- `name`：管理员用户名
- `role`：角色
  - `'super_admin'`：超级管理员
  - `'chief_editor'`：主编
  - `'editor'`：编辑
  - `'finance'`：财务
  - `'operator'`：运营
- `real_name`：真实姓名（用于结算实名）

---

### 1.7 chapter_unlocks（章节解锁表）

**表结构**：
```sql
CREATE TABLE `chapter_unlocks` (
  `id` int NOT NULL AUTO_INCREMENT,
  `user_id` int NOT NULL COMMENT '读者用户ID',
  `chapter_id` int NOT NULL COMMENT '章节ID',
  `unlock_method` enum('free','key','karma','subscription','auto_unlock','time_unlock') NOT NULL COMMENT '解锁方式',
  `cost` int DEFAULT '0' COMMENT '实际花费的钥匙或业力数量',
  `unlocked_at` datetime DEFAULT NULL COMMENT '解锁时间',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `first_clicked_at` datetime DEFAULT NULL COMMENT '首次点击时间',
  `unlock_at` datetime DEFAULT NULL COMMENT '预计解锁时间',
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `status` enum('pending','unlocked','cancelled') DEFAULT NULL,
  `next_chapter_id` int DEFAULT NULL COMMENT '下一章节ID',
  `readed` tinyint(1) DEFAULT '0' COMMENT '是否已阅读',
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_user_chapter` (`user_id`,`chapter_id`),
  KEY `chapter_id` (`chapter_id`),
  CONSTRAINT `chapter_unlocks_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE,
  CONSTRAINT `chapter_unlocks_ibfk_2` FOREIGN KEY (`chapter_id`) REFERENCES `chapter` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=140 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
```

**关键字段说明**：
- `id`：解锁记录ID（对应 `reader_spending.source_id`，当 `source_type='chapter_unlock'` 时）
- `chapter_id`：章节ID（关联 `chapter.id`）
- `unlock_method`：解锁方式
  - `'karma'`：使用 Karma 解锁（会生成 `reader_spending` 记录）
  - `'subscription'`：订阅解锁（不生成 `reader_spending` 记录，订阅收入单独处理）
- `cost`：实际花费的 Karma 数量
- `unlocked_at`：解锁时间（用于判断当时生效的合同）

**关联关系**：
- `reader_spending.source_id` = `chapter_unlocks.id`（当 `source_type='chapter_unlock'` 时）
- `chapter_unlocks.chapter_id` = `chapter.id`
- `chapter.editor_admin_id` / `chapter.chief_editor_admin_id` = `admin.id`

### 1.8 其他编辑相关表

**editor_novel_application**（编辑申请小说表）：
- 用于编辑申请管理小说，与收入计算无关

---

## 二、后端代码使用点

### 2.1 editor_income_monthly 相关接口

#### 2.1.1 生成/计算编辑收入接口

**接口1：计算单本小说的 Champion 收入分配**
- **路由**：`POST /api/admin/editor-income/calculate-champion`
- **文件位置**：`backend/routes/admin.js` 第 9442-9471 行
- **权限要求**：`super_admin` 或 `finance`
- **功能**：计算并分配某小说某月的 Champion 收入给编辑
- **调用服务**：`editorIncomeService.calculateChampionIncomeForNovel(novelId, month)`

**接口2：批量计算多本小说的 Champion 收入分配**
- **路由**：`POST /api/admin/editor-income/batch-calculate-champion`
- **文件位置**：`backend/routes/admin.js` 第 9474-9510 行
- **权限要求**：`super_admin` 或 `finance`
- **功能**：批量计算多本小说的 Champion 收入分配
- **调用服务**：`editorIncomeService.calculateChampionIncomeForNovels(novelIds, month)`

#### 2.1.2 当前算法说明（editorIncomeService.js）

**文件位置**：`backend/services/editorIncomeService.js` 第 25-221 行

**当前算法流程**：

1. **数据来源**：从 `novel_income_monthly` 表查询 Champion 收入
   ```sql
   SELECT income_usd 
   FROM novel_income_monthly 
   WHERE novel_id = ? AND month = ? AND income_type = 'champion'
   ```
   ⚠️ **注意**：当前算法**不直接使用 `reader_spending` 表**，而是依赖 `novel_income_monthly` 表（该表可能不存在或未使用）

2. **查找合同**：从 `novel_editor_contract` 表获取主编和编辑的分成比例
   ```sql
   SELECT editor_admin_id, role, share_percent 
   FROM novel_editor_contract 
   WHERE novel_id = ? 
     AND share_type = 'percent_of_book' 
     AND status = 'active'
   ```
   - 按 `role` 分类：`chief_editor`（主编池）和 `editor`（编辑池）
   - 计算主编池比例和编辑池比例

3. **主编收入计算**：
   - 主编池金额 = Champion收入 × 主编池比例
   - 如果有多个主编合同，按 `share_percent` 比例分配

4. **编辑收入计算**（按字数比例）：
   ```sql
   SELECT c.editor_admin_id, COALESCE(SUM(c.word_count), 0) AS total_words
   FROM chapter c
   WHERE c.novel_id = ? 
     AND c.is_released = 1 
     AND c.editor_admin_id IS NOT NULL
   GROUP BY c.editor_admin_id
   ```
   - 统计每个编辑负责的总字数
   - 编辑池金额按字数比例分配给各编辑

5. **写入 editor_income_monthly**：
   ```sql
   INSERT INTO editor_income_monthly 
     (editor_admin_id, novel_id, month, gross_book_income_usd, editor_income_usd, updated_at)
   VALUES (?, ?, ?, ?, ?, NOW())
   ON DUPLICATE KEY UPDATE
     gross_book_income_usd = gross_book_income_usd + VALUES(gross_book_income_usd),
     editor_income_usd = editor_income_usd + VALUES(editor_income_usd),
     updated_at = NOW()
   ```
   - 使用 `ON DUPLICATE KEY UPDATE` 实现 upsert
   - 如果记录已存在，累加金额

**当前算法的局限性**：
- ❌ **不直接使用 `reader_spending` 表**，而是依赖可能不存在的 `novel_income_monthly` 表
- ❌ **只计算 Champion 订阅收入**，不包含章节解锁收入
- ❌ **不区分 `source_type`**（章节解锁 vs 订阅）
- ❌ **不按 `settlement_month` 过滤**，而是按 `month` 参数查询 `novel_income_monthly`

#### 2.1.3 查询编辑收入列表接口

**当前状态**：❌ **不存在**

**说明**：当前项目中**没有任何查询 `editor_income_monthly` 表的接口**，也没有前端页面展示编辑收入列表。

---

### 2.2 reader_spending 相关接口

#### 2.2.1 生成基础收入数据（reader_spending）

**路由**：`POST /api/admin/generate-reader-spending`
- **文件位置**：`backend/routes/admin.js` 第 1665-2036 行
- **功能**：从 `chapter_unlocks` 和 `user_champion_subscription_record` 生成 `reader_spending` 数据
- **数据来源**：
  1. **章节解锁**：`chapter_unlocks` 表（`unlock_method='karma' AND cost>0`）
  2. **订阅**：`user_champion_subscription_record` 表（按服务期拆分到多个月份）

#### 2.2.2 查询基础收入数据（reader_spending）

**路由**：`GET /api/admin/reader-spending`
- **文件位置**：`backend/routes/admin.js` 第 2039-2123 行
- **功能**：查询指定月份的 `reader_spending` 数据（汇总统计 + 详细列表）

#### 2.2.3 删除基础收入数据（reader_spending）

**路由**：`DELETE /api/admin/reader-spending`
- **文件位置**：`backend/routes/admin.js` 第 2126-2178 行
- **功能**：删除指定月份的 `reader_spending` 数据（已结算的数据无法删除）

---

### 2.3 其他相关接口

#### 2.3.1 作者基础收入生成

**路由**：`POST /api/admin/author-royalty/generate`
- **文件位置**：`backend/routes/admin.js` 第 2289-2467 行
- **功能**：从 `reader_spending` 生成 `author_royalty` 数据
- **数据来源**：`reader_spending` 表（`WHERE settlement_month = ?`）

#### 2.3.2 推广佣金明细生成

**路由**：`POST /api/admin/commission-transaction/generate`
- **文件位置**：`backend/routes/admin.js` 第 2605-2895 行
- **功能**：从 `reader_spending` 和 `author_royalty` 生成 `commission_transaction` 数据
- **数据来源**：
  1. **读者推广**：`reader_spending` 表
  2. **作者推广**：`author_royalty` 表

---

## 三、前端后台页面情况

### 3.1 现有编辑相关页面

#### 3.1.1 编辑管理页面

**文件路径**：`frontend/src/pages/AdminPanel/EditorManagement/index.tsx`
- **菜单名称**：`收益与编辑管理` → `编辑管理`
- **功能**：显示编辑列表（调用 `GET /api/admin/list-editors`）
- **与收入的关系**：❌ **无关**，仅用于管理编辑账号

#### 3.1.2 其他编辑相关页面

- **章节审批**：`frontend/src/pages/AdminPanel/ChapterApproval/index.tsx`
  - 功能：审批章节，分配编辑/主编
  - 与收入的关系：❌ **无关**

### 3.2 现有收入统计页面

#### 3.2.1 基础收入统计-1

**文件路径**：`frontend/src/pages/AdminPanel/BaseIncome/index.tsx`
- **菜单名称**：`收益与编辑管理` → `基础收入统计-1`
- **调用接口**：
  - `GET /api/admin/reader-spending?month=...`（查询）
  - `POST /api/admin/generate-reader-spending`（生成）
  - `DELETE /api/admin/reader-spending?month=...`（删除）
- **数据来源**：`reader_spending` 表

#### 3.2.2 作者基础收入表-2

**文件路径**：`frontend/src/pages/AdminPanel/AuthorRoyalty/index.tsx`
- **菜单名称**：`收益与编辑管理` → `作者基础收入表-2`
- **调用接口**：
  - `GET /api/admin/author-royalty?month=...`（查询）
  - `POST /api/admin/author-royalty/generate`（生成）
  - `DELETE /api/admin/author-royalty?month=...`（删除）
- **数据来源**：`author_royalty` 表（从 `reader_spending` 生成）

#### 3.2.3 推广佣金明细-3

**文件路径**：`frontend/src/pages/AdminPanel/CommissionTransaction/index.tsx`
- **菜单名称**：`收益与编辑管理` → `推广佣金明细-3`
- **调用接口**：
  - `GET /api/admin/commission-transaction?month=...`（查询）
  - `POST /api/admin/commission-transaction/generate`（生成）
  - `DELETE /api/admin/commission-transaction?month=...`（删除）
- **数据来源**：`commission_transaction` 表（从 `reader_spending` 和 `author_royalty` 生成）

### 3.3 编辑收入相关页面

**当前状态**：❌ **不存在**

**说明**：当前前端**没有任何"编辑收入统计"或"编辑基础收入"相关的页面**。

---

## 四、和 reader_spending / 结算体系的关系

### 4.1 当前结算链路

```
┌─────────────────────────────────────────────────────────────┐
│  当前结算链路（不包含编辑收入）                                │
└─────────────────────────────────────────────────────────────┘

1. reader_spending（基础收入统计）
   ├─ 来源1：chapter_unlocks（章节解锁）
   │   └─ 筛选：unlocked_at 在月份范围内 + unlock_method='karma' + cost>0
   │   └─ 计算：amount_usd = karma_amount × usd_per_karma
   │   └─ 存储：settlement_month = '2025-11-01'
   │
   └─ 来源2：user_champion_subscription_record（订阅）
       └─ 筛选：服务期与月份有交集 + payment_status='completed' + payment_amount>0
       └─ 计算：amount_usd = payment_amount × (overlapDays / totalDays)
       └─ 存储：settlement_month = '2025-11-01'（可能拆分到多个月份）

2. author_royalty（作者基础收入表）
   └─ 来源：reader_spending
       └─ 筛选：settlement_month = '2025-11-01'
       └─ 关联：novel.user_id（作者ID）
       └─ 计算：author_amount_usd = amount_usd × royalty_percent
       └─ 存储：settlement_month = '2025-11-01'

3. commission_transaction（推广佣金明细）
   ├─ 来源1：reader_spending（读者推广）
   │   └─ 筛选：settlement_month = '2025-11-01'
   │   └─ 推广链：沿 referrals 表向上查找多级上线
   │
   └─ 来源2：author_royalty（作者推广）
       └─ 筛选：settlement_month = '2025-11-01'
       └─ 推广链：沿 referrals 表向上查找多级上线

4. user_income_monthly（用户月度收入汇总）
   └─ 来源：author_royalty + commission_transaction
       └─ 汇总：按 user_id + month 分组
```

### 4.2 当前编辑收入计算（独立于结算体系）

```
┌─────────────────────────────────────────────────────────────┐
│  当前编辑收入计算（独立于 reader_spending）                    │
└─────────────────────────────────────────────────────────────┘

1. novel_income_monthly（可能不存在）
   └─ 查询：WHERE novel_id = ? AND month = ? AND income_type = 'champion'
   └─ ⚠️ 问题：该表可能不存在或未使用

2. novel_editor_contract（合同）
   └─ 查询：WHERE novel_id = ? AND share_type = 'percent_of_book' AND status = 'active'
   └─ 分类：chief_editor（主编池）和 editor（编辑池）

3. chapter（章节）
   └─ 查询：WHERE novel_id = ? AND is_released = 1 AND editor_admin_id IS NOT NULL
   └─ 统计：按 editor_admin_id 分组，SUM(word_count)

4. editor_income_monthly（编辑收入）
   └─ 写入：按编辑分配收入（主编按合同比例，编辑按字数比例）
```

### 4.3 当前结算链路中是否涉及编辑

**结论**：❌ **不涉及**

**说明**：
- `reader_spending` 生成时，**不涉及编辑信息**
- `author_royalty` 生成时，**不涉及编辑信息**
- `commission_transaction` 生成时，**不涉及编辑信息**
- 当前结算链路**完全独立于编辑收入计算**

### 4.4 将来新加"编辑基础收入-4"时可以复用的代码

#### 4.4.1 可以复用的代码模式

1. **月份格式转换**（`backend/routes/admin.js` 第 2303-2304 行）：
   ```javascript
   const settlementMonth = `${month}-01`; // 前端传 '2025-11'，后端转成 '2025-11-01'
   ```

2. **查询 reader_spending 的模式**（`backend/routes/admin.js` 第 2346-2358 行）：
   ```javascript
   const [spendings] = await db.execute(
     `SELECT rs.id, rs.user_id, rs.novel_id, rs.amount_usd, rs.spend_time, rs.source_type
      FROM reader_spending rs
      WHERE rs.settlement_month = ?
      ORDER BY rs.spend_time`,
     [settlementMonth]
   );
   ```

3. **查找生效合同的模式**（`backend/services/editorIncomeService.js` 第 78-85 行）：
   ```javascript
   const [contracts] = await db.execute(
     `SELECT editor_admin_id, role, share_percent 
      FROM novel_editor_contract 
      WHERE novel_id = ? 
        AND share_type = 'percent_of_book' 
        AND status = 'active'`,
     [novelId]
   );
   ```

4. **按时间判断合同生效的模式**（`backend/routes/admin.js` 第 2373-2383 行）：
   ```javascript
   const [contracts] = await db.execute(
     `SELECT plan_id 
      FROM novel_royalty_contract 
      WHERE novel_id = ? AND author_id = ?
        AND effective_from <= ? AND (effective_to IS NULL OR effective_to > ?)
      ORDER BY effective_from DESC LIMIT 1`,
     [novelId, authorId, spending.spend_time, spending.spend_time]
   );
   ```

5. **UPSERT 模式**（`backend/services/editorIncomeService.js` 第 180-189 行）：
   ```javascript
   await db.execute(
     `INSERT INTO editor_income_monthly 
      (editor_admin_id, novel_id, month, gross_book_income_usd, editor_income_usd, updated_at)
      VALUES (?, ?, ?, ?, ?, NOW())
      ON DUPLICATE KEY UPDATE
      gross_book_income_usd = gross_book_income_usd + VALUES(gross_book_income_usd),
      editor_income_usd = editor_income_usd + VALUES(editor_income_usd),
      updated_at = NOW()`,
     [editorId, novelId, monthDate, grossAmount, editorAmount]
   );
   ```

#### 4.4.4.2 需要修改的部分

1. **数据来源**：
   - 当前：从 `novel_income_monthly` 查询（可能不存在）
   - 将来：从 `reader_spending` 查询（`WHERE settlement_month = ?`）

2. **收入类型**：
   - 当前：只计算 Champion 订阅收入
   - 将来：需要包含章节解锁（`source_type='chapter_unlock'`）和订阅（`source_type='subscription'`）

3. **编辑分配逻辑**：
   - 当前：主编按合同比例，编辑按字数比例
   - 将来：需要根据 `reader_spending.source_type` 和 `chapter.editor_admin_id` / `chapter.chief_editor_admin_id` 来确定编辑

4. **章节关联**：
   - 当前：统计所有已发布章节的字数
   - 将来：需要关联 `reader_spending.source_id`（章节解锁时）或按小说整体分配（订阅时）

---

## 五、关键发现总结

### 5.1 数据库表结构

✅ **editor_income_monthly 表已存在**，字段结构完整：
- `editor_admin_id`、`novel_id`、`month`（唯一约束）
- `gross_book_income_usd`、`editor_share_percent`、`editor_income_usd`
- 支持按编辑、小说、月份查询

✅ **reader_spending 表结构完整**：
- `source_type`（章节解锁/订阅）
- `settlement_month`（结算月份）
- `source_id`（可关联到 `chapter_unlocks.id` 或 `user_champion_subscription_record.id`）

✅ **chapter 表包含编辑信息**：
- `editor_admin_id`（责任编辑）
- `chief_editor_admin_id`（主编）
- `word_count`（字数）

✅ **novel_editor_contract 表包含合同信息**：
- `role`（主编/编辑）
- `share_percent`（分成比例）
- `start_date` / `end_date`（生效时间）

### 5.2 后端代码现状

✅ **存在编辑收入计算服务**（`editorIncomeService.js`）：
- 但**不直接使用 `reader_spending` 表**
- 依赖可能不存在的 `novel_income_monthly` 表
- 只计算 Champion 订阅收入，不包含章节解锁收入

❌ **不存在查询编辑收入列表的接口**：
- 没有 `GET /api/admin/editor-income` 接口
- 没有前端页面展示编辑收入

### 5.3 前端页面现状

❌ **不存在"编辑基础收入"相关页面**：
- 前端没有任何页面展示或生成编辑收入
- 只有"编辑管理"页面（用于管理编辑账号）

### 5.4 结算体系关系

✅ **reader_spending 是结算体系的核心**：
- 所有收入统计都基于 `reader_spending` 表
- `author_royalty` 和 `commission_transaction` 都从 `reader_spending` 生成

❌ **当前编辑收入计算独立于结算体系**：
- 不使用 `reader_spending` 表
- 不按 `settlement_month` 过滤
- 不区分 `source_type`（章节解锁 vs 订阅）

---

## 六、实现"编辑基础收入-4"的关键点

### 6.1 数据来源

**应该从 `reader_spending` 表查询**：
```sql
SELECT rs.id, rs.novel_id, rs.amount_usd, rs.source_type, rs.source_id, rs.spend_time
FROM reader_spending rs
WHERE rs.settlement_month = '2025-11-01'
```

### 6.2 编辑分配逻辑

**对于章节解锁（`source_type='chapter_unlock'`）**：
1. 通过 `source_id` 关联 `chapter_unlocks.id`
2. 通过 `chapter_unlocks.chapter_id` 关联 `chapter.id`
3. 获取 `chapter.editor_admin_id`（责任编辑）和 `chapter.chief_editor_admin_id`（主编）
4. 根据 `novel_editor_contract` 合同（使用 `reader_spending.spend_time` 判断生效时间）确定分成比例
5. 按编辑分配收入：
   - 如果 `chapter.editor_admin_id` 存在，分配给该编辑
   - 如果 `chapter.chief_editor_admin_id` 存在，分配给该主编

**对于订阅（`source_type='subscription'`）**：
1. 按小说整体分配（不区分具体章节）
2. 根据 `novel_editor_contract` 合同确定分成比例
3. 主编按合同比例，编辑按字数比例（或按合同比例）

### 6.3 合同生效时间判断

**应该使用 `reader_spending.spend_time` 判断合同是否生效**：
```sql
SELECT editor_admin_id, role, share_percent 
FROM novel_editor_contract 
WHERE novel_id = ?
  AND share_type = 'percent_of_book' 
  AND status = 'active'
  AND start_date <= ?  -- spending.spend_time
  AND (end_date IS NULL OR end_date > ?)  -- spending.spend_time
```

### 6.4 editor_income_monthly 表扩展

**当前字段**：
- `gross_book_income_usd`：作品总收入
- `editor_income_usd`：编辑收入

**可能需要新增字段**（如果业务需要）：
- `source_type`：来源类型（章节解锁/订阅）
- `source_spend_id`：对应的 `reader_spending.id`
- `editor_role`：编辑角色（主编/编辑）

**或者保持当前结构**，在生成时按 `(editor_admin_id, novel_id, month)` 汇总所有来源的收入。

---

## 七、建议的实现方案（概要）

### 7.1 后端接口

1. **生成编辑基础收入**：
   - 路由：`POST /api/admin/editor-income/generate`
   - 参数：`{ month: "2025-11" }`
   - 逻辑：
     - 从 `reader_spending` 查询 `WHERE settlement_month = '2025-11-01'`
     - 对每条记录：
       - 如果是章节解锁：关联 `chapter` 表，获取编辑信息
       - 如果是订阅：按小说整体分配
       - 查找生效的 `novel_editor_contract` 合同
       - 计算编辑收入
       - 写入/更新 `editor_income_monthly`

2. **查询编辑基础收入列表**：
   - 路由：`GET /api/admin/editor-income?month=...&editor_id=...&novel_id=...`
   - 逻辑：从 `editor_income_monthly` 表查询，关联 `admin` 和 `novel` 表

3. **删除编辑基础收入**：
   - 路由：`DELETE /api/admin/editor-income?month=...`
   - 逻辑：删除指定月份的 `editor_income_monthly` 数据

### 7.2 前端页面

1. **创建新页面**：`frontend/src/pages/AdminPanel/EditorIncome/index.tsx`
2. **菜单项**：在 `收益与编辑管理` 分组下添加 `编辑基础收入-4`
3. **功能**：
   - 月份选择器
   - 「生成」按钮（调用 `POST /api/admin/editor-income/generate`）
   - 「查询」按钮（调用 `GET /api/admin/editor-income`）
   - 「删除」按钮（调用 `DELETE /api/admin/editor-income`）
   - 汇总统计卡片（总记录数、总金额、编辑数量等）
   - 详细列表表格（编辑ID、编辑名称、小说ID、小说名称、收入金额等）

---

## 八、总结

### 8.1 当前状态

✅ **数据库表结构完整**：
- `editor_income_monthly` 表已存在，字段结构合理
- `reader_spending`、`chapter`、`novel_editor_contract` 表都包含必要字段

❌ **后端代码不完整**：
- 存在编辑收入计算服务，但**不直接使用 `reader_spending` 表**
- 依赖可能不存在的 `novel_income_monthly` 表
- **不存在查询编辑收入列表的接口**

❌ **前端页面不存在**：
- 没有任何"编辑基础收入"相关页面

### 8.2 实现"编辑基础收入-4"的关键点

1. **数据来源**：从 `reader_spending` 表查询（`WHERE settlement_month = ?`）
2. **编辑分配**：
   - 章节解锁：通过 `source_id` 关联 `chapter` 表，获取编辑信息
   - 订阅：按小说整体分配，根据合同和字数比例
3. **合同判断**：使用 `reader_spending.spend_time` 判断合同是否生效
4. **表结构**：可以复用现有的 `editor_income_monthly` 表结构，或根据需要扩展字段

### 8.3 可复用的代码

1. 月份格式转换逻辑（`${month}-01`）
2. `reader_spending` 查询模式
3. 合同生效时间判断模式
4. UPSERT 写入模式
5. 前端页面结构（参考 `BaseIncome`、`AuthorRoyalty` 等页面）

---

**报告完成时间**：2025-11-29  
**下一步**：根据此报告，可以开始实现「编辑基础收入-4」页面和相关的后端接口

