# åå°ç¼–è¾‘ç®¡ç† & èœå•æƒé™ç°çŠ¶åˆ†ææŠ¥å‘Š

## 1. ç¼–è¾‘ç®¡ç†ä¸»é¡µé¢ä¸å­é€‰é¡¹å¡ç»“æ„

### æ–‡ä»¶è·¯å¾„
- **ä¸»é¡µé¢ç»„ä»¶**ï¼š`frontend/src/pages/AdminPanel.tsx`
- **ç¼–è¾‘ç®¡ç†å­ç»„ä»¶**ï¼š`frontend/src/pages/AdminPanel/AdminUserPage/index.tsx`

### å…³é”®çŠ¶æ€å˜é‡

#### ä¸»é¡µé¢ï¼ˆAdminPanel.tsxï¼‰
- **`activeTab`**ï¼ˆç¬¬98è¡Œï¼‰ï¼šç±»å‹ä¸º `TabType`ï¼Œæ§åˆ¶ä¸»é¡µé¢é¡¶éƒ¨ä¸€çº§ Tab åˆ‡æ¢
  - ç±»å‹å®šä¹‰ï¼š`type TabType = 'novel-review' | 'new-novel-pool' | 'chapter-approval' | 'payment-stats' | 'author-income' | 'reader-income' | 'base-income' | 'author-royalty' | 'commission-transaction' | 'editor-base-income' | 'commission-settings' | 'settlement-overview' | 'editor-management' | 'admin-payout-account';`
  - ç¼–è¾‘ç®¡ç†å¯¹åº”çš„å€¼ä¸ºï¼š`'editor-management'`

#### ç¼–è¾‘ç®¡ç†å­é¡µé¢ï¼ˆAdminUserPage/index.tsxï¼‰
- **`activeTab`**ï¼ˆç¬¬13è¡Œï¼‰ï¼šç±»å‹ä¸º `'account' | 'contract' | 'approval'`ï¼Œæ§åˆ¶ç¼–è¾‘ç®¡ç†é¡µé¢å†…éƒ¨çš„ä¸‰ä¸ªå­ Tab
  - `'account'`ï¼šè´¦å·ç®¡ç†
  - `'contract'`ï¼šåˆåŒç®¡ç†
  - `'approval'`ï¼šåˆåŒå®¡æ‰¹

### ç°æœ‰å­ Tab å®ç°

åœ¨ `AdminUserPage/index.tsx` ä¸­ï¼Œä¸‰ä¸ªå­ Tab çš„å®ç°å¦‚ä¸‹ï¼š

1. **è´¦å·ç®¡ç† Tab**ï¼ˆç¬¬84-89è¡Œï¼‰ï¼š
   ```tsx
   <button
     className={`${styles.tab} ${activeTab === 'account' ? styles.activeTab : ''}`}
     onClick={() => setActiveTab('account')}
   >
     è´¦å·ç®¡ç†
   </button>
   ```
   - å¯¹åº”ç»„ä»¶ï¼š`<AccountManagementTab />`ï¼ˆç¬¬106-111è¡Œï¼‰
   - ç»„ä»¶è·¯å¾„ï¼š`frontend/src/pages/AdminPanel/AdminUserPage/AccountManagementTab.tsx`

2. **åˆåŒç®¡ç† Tab**ï¼ˆç¬¬90-95è¡Œï¼‰ï¼š
   ```tsx
   <button
     className={`${styles.tab} ${activeTab === 'contract' ? styles.activeTab : ''}`}
     onClick={() => setActiveTab('contract')}
   >
     åˆåŒç®¡ç†
   </button>
   ```
   - å¯¹åº”ç»„ä»¶ï¼š`<ContractManagementTab />`ï¼ˆç¬¬112-117è¡Œï¼‰
   - ç»„ä»¶è·¯å¾„ï¼š`frontend/src/pages/AdminPanel/AdminUserPage/ContractManagementTab.tsx`

3. **åˆåŒå®¡æ‰¹ Tab**ï¼ˆç¬¬96-101è¡Œï¼‰ï¼š
   ```tsx
   <button
     className={`${styles.tab} ${activeTab === 'approval' ? styles.activeTab : ''}`}
     onClick={() => setActiveTab('approval')}
   >
     åˆåŒå®¡æ‰¹
   </button>
   ```
   - å¯¹åº”ç»„ä»¶ï¼š`<ContractApprovalTab />`ï¼ˆç¬¬118-123è¡Œï¼‰
   - ç»„ä»¶è·¯å¾„ï¼š`frontend/src/pages/AdminPanel/AdminUserPage/ContractApprovalTab.tsx`

### è·¯ç”±æˆ–æ¡ä»¶æ¸²æŸ“é€»è¾‘

#### ä¸»é¡µé¢è·¯ç”±
- ä¸»é¡µé¢ä½¿ç”¨çŠ¶æ€é©±åŠ¨çš„æ¡ä»¶æ¸²æŸ“ï¼Œæ²¡æœ‰ä½¿ç”¨ React Router
- ç¼–è¾‘ç®¡ç†é¡µé¢çš„æ¸²æŸ“é€»è¾‘ï¼ˆAdminPanel.tsx ç¬¬3308-3310è¡Œï¼‰ï¼š
  ```tsx
  {activeTab === 'editor-management' && (
    <AdminUserPage onError={setError} />
  )}
  ```

#### å­é¡µé¢è·¯ç”±
- ç¼–è¾‘ç®¡ç†å­é¡µé¢åŒæ ·ä½¿ç”¨çŠ¶æ€é©±åŠ¨çš„æ¡ä»¶æ¸²æŸ“
- Tab åˆ‡æ¢é€šè¿‡ `setActiveTab` å‡½æ•°æ§åˆ¶ï¼ˆç¬¬13è¡Œï¼‰
- å†…å®¹åŒºåŸŸé€šè¿‡æ¡ä»¶æ¸²æŸ“æ˜¾ç¤ºå¯¹åº”ç»„ä»¶ï¼ˆç¬¬105-124è¡Œï¼‰

### æ–°å¢ Tab ä½ç½®è¯´æ˜

å¦‚æœè¦åœ¨ç¼–è¾‘ç®¡ç†é¡µé¢ä¸­æ–°å¢"è´¦å·æƒé™ç®¡ç†"Tabï¼Œéœ€è¦ä¿®æ”¹ä»¥ä¸‹ä½ç½®ï¼š

1. **çŠ¶æ€å˜é‡æ‰©å±•**ï¼ˆ`AdminUserPage/index.tsx` ç¬¬13è¡Œï¼‰ï¼š
   - å°† `activeTab` ç±»å‹æ‰©å±•ä¸ºï¼š`'account' | 'contract' | 'approval' | 'permission'`
   - æˆ–ä½¿ç”¨æ›´çµæ´»çš„æ–¹å¼ï¼š`'account' | 'contract' | 'approval' | string`

2. **Tab æŒ‰é’®æ·»åŠ **ï¼ˆ`AdminUserPage/index.tsx` ç¬¬83-102è¡Œï¼‰ï¼š
   - åœ¨ç°æœ‰ä¸‰ä¸ª Tab æŒ‰é’®åæ·»åŠ æ–°çš„æŒ‰é’®ï¼ˆçº¦ç¬¬102è¡Œåï¼‰
   - ä»£ç ç»“æ„ï¼š
     ```tsx
     <button
       className={`${styles.tab} ${activeTab === 'permission' ? styles.activeTab : ''}`}
       onClick={() => setActiveTab('permission')}
     >
       è´¦å·æƒé™ç®¡ç†
     </button>
     ```

3. **å†…å®¹åŒºåŸŸæ·»åŠ **ï¼ˆ`AdminUserPage/index.tsx` ç¬¬105-124è¡Œï¼‰ï¼š
   - åœ¨ç°æœ‰ä¸‰ä¸ªæ¡ä»¶æ¸²æŸ“å—åæ·»åŠ æ–°çš„æ¡ä»¶æ¸²æŸ“ï¼ˆçº¦ç¬¬124è¡Œåï¼‰
   - ä»£ç ç»“æ„ï¼š
     ```tsx
     {activeTab === 'permission' && (
       <PermissionManagementTab 
         onError={onError} 
         adminApiRequest={adminApiRequest}
       />
     )}
     ```

4. **åˆ›å»ºæ–°ç»„ä»¶æ–‡ä»¶**ï¼š
   - è·¯å¾„ï¼š`frontend/src/pages/AdminPanel/AdminUserPage/PermissionManagementTab.tsx`
   - å‚è€ƒç°æœ‰ Tab ç»„ä»¶çš„ç»“æ„ï¼ˆå¦‚ `AccountManagementTab.tsx`ï¼‰

## 2. å·¦ä¾§å¯¼èˆªèœå•ä¸"æ”¶ç›Šä¸ç¼–è¾‘ç®¡ç†"åˆ†ç»„ç»“æ„

### èœå•é…ç½®æ–‡ä»¶åŠè·¯å¾„

- **èœå•å®šä¹‰ä½ç½®**ï¼š`frontend/src/pages/AdminPanel.tsx`ï¼ˆç¬¬1616-1722è¡Œï¼‰
- **èœå•å®ç°æ–¹å¼**ï¼šç›´æ¥åœ¨ JSX ä¸­ç¡¬ç¼–ç ï¼Œæœªä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–æ•°ç»„é…ç½®

### "æ”¶ç›Šä¸ç¼–è¾‘ç®¡ç†"åˆ†ç»„ç»“æ„

#### åˆ†ç»„å®ç°æ–¹å¼

èœå•ä½¿ç”¨**å¯æŠ˜å çš„åˆ†ç»„ç»“æ„**å®ç°ï¼ˆç¬¬1636-1713è¡Œï¼‰ï¼š

```tsx
<div className={styles.navGroup}>
  <div 
    className={styles.navGroupHeader} 
    onClick={() => setIncomeAndEditorMenuExpanded(!incomeAndEditorMenuExpanded)}
  >
    <div className={styles.navIcon}>ğŸ’¼</div>
    <span>æ”¶ç›Šä¸ç¼–è¾‘ç®¡ç†</span>
    <span className={styles.expandIcon}>
      {incomeAndEditorMenuExpanded ? 'â–¼' : 'â–¶'}
    </span>
  </div>
  {incomeAndEditorMenuExpanded && (
    <div className={styles.navSubItems}>
      {/* å­èœå•é¡¹ */}
    </div>
  )}
</div>
```

#### åˆ†ç»„çŠ¶æ€ç®¡ç†

- **çŠ¶æ€å˜é‡**ï¼š`incomeAndEditorMenuExpanded`ï¼ˆç¬¬102è¡Œï¼‰
- **ç±»å‹**ï¼š`boolean`
- **ä½œç”¨**ï¼šæ§åˆ¶"æ”¶ç›Šä¸ç¼–è¾‘ç®¡ç†"åˆ†ç»„çš„å±•å¼€/æŠ˜å çŠ¶æ€

#### "æ”¶ç›Šä¸ç¼–è¾‘ç®¡ç†"åˆ†ç»„ç»“æ„ç¤ºæ„

```
æ”¶ç›Šä¸ç¼–è¾‘ç®¡ç† (ğŸ’¼)
  â”œâ”€ è´¹ç”¨ç»Ÿè®¡ (ğŸ’°) - key: 'payment-stats'
  â”œâ”€ ä½œè€…æ”¶å…¥ç»Ÿè®¡ (âœï¸) - key: 'author-income'
  â”œâ”€ è¯»è€…æ”¶å…¥ç»Ÿè®¡ (ğŸ‘¥) - key: 'reader-income'
  â”œâ”€ ç»“ç®—æ€»è§ˆ (ğŸ’³) - key: 'settlement-overview'
  â”œâ”€ åŸºç¡€æ”¶å…¥ç»Ÿè®¡-1 (ğŸ“Š) - key: 'base-income'
  â”œâ”€ ä½œè€…åŸºç¡€æ”¶å…¥è¡¨-2 (ğŸ’µ) - key: 'author-royalty'
  â”œâ”€ æ¨å¹¿ä½£é‡‘æ˜ç»†-3 (ğŸ’°) - key: 'commission-transaction'
  â”œâ”€ ç¼–è¾‘åŸºç¡€æ”¶å…¥-4 (ğŸ“) - key: 'editor-base-income'
  â”œâ”€ ææˆè®¾ç½® (âš™ï¸) - key: 'commission-settings'
  â””â”€ ç¼–è¾‘ç®¡ç† (ğŸ‘¥) - key: 'editor-management'
```

#### ç¼–è¾‘ç®¡ç†èœå•é¡¹é…ç½®

- **ä½ç½®**ï¼šç¬¬1705-1710è¡Œ
- **å®ç°ä»£ç **ï¼š
  ```tsx
  <div className={`${styles.navSubItem} ${activeTab === 'editor-management' ? styles.active : ''}`} 
       onClick={() => setActiveTab('editor-management')}>
    <div className={`${styles.navIcon} ${activeTab === 'editor-management' ? styles.active : ''}`}>
      ğŸ‘¥
    </div>
    <span className={activeTab === 'editor-management' ? styles.active : ''}>ç¼–è¾‘ç®¡ç†</span>
  </div>
  ```
- **key/æ ‡è¯†**ï¼š`'editor-management'`ï¼ˆå¯¹åº” `activeTab` çš„å€¼ï¼‰
- **è·¯ç”± path**ï¼šæ— ï¼ˆä½¿ç”¨çŠ¶æ€é©±åŠ¨ï¼Œéè·¯ç”±ï¼‰
- **ç»„ä»¶å¯¹åº”å…³ç³»**ï¼šç‚¹å‡»åè®¾ç½® `activeTab = 'editor-management'`ï¼Œè§¦å‘ä¸»é¡µé¢æ¸²æŸ“ `<AdminUserPage />` ç»„ä»¶

### ç°æœ‰æƒé™è¿‡æ»¤é€»è¾‘

#### èœå•çº§åˆ«æƒé™æ§åˆ¶

**å½“å‰çŠ¶æ€**ï¼š**æœªå‘ç°èœå•çº§åˆ«çš„æƒé™è¿‡æ»¤é€»è¾‘**

- èœå•é¡¹æ¸²æŸ“å‰æ²¡æœ‰æ ¹æ®è§’è‰²æˆ–æƒé™è¿›è¡Œè¿‡æ»¤
- æ‰€æœ‰èœå•é¡¹å¯¹æ‰€æœ‰ç™»å½•çš„ç®¡ç†å‘˜å¯è§
- æƒé™æ§åˆ¶ä¸»è¦åœ¨**é¡µé¢/æ¥å£çº§åˆ«**å®ç°

#### é¡µé¢çº§åˆ«æƒé™æ§åˆ¶

åœ¨ `AdminUserPage/index.tsx` ä¸­ï¼Œå­˜åœ¨é¡µé¢çº§åˆ«çš„æƒé™æ£€æŸ¥ï¼š

1. **API è¯·æ±‚æ‹¦æˆª**ï¼ˆç¬¬31-40è¡Œï¼‰ï¼š
   - å½“ API è¿”å› 403 çŠ¶æ€ç ä¸”é”™è¯¯ä¿¡æ¯åŒ…å«"æƒé™"æ—¶ï¼Œè®¾ç½® `noPermission = true`
   - æ˜¾ç¤ºé”™è¯¯æç¤ºï¼š"æ²¡æœ‰æƒé™è®¿é—®ç¼–è¾‘ç®¡ç†ï¼Œè¯·ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜è´¦å·ç™»å½•ã€‚"

2. **æƒé™ä¸è¶³æ—¶çš„ UI**ï¼ˆç¬¬66-74è¡Œï¼‰ï¼š
   ```tsx
   if (noPermission) {
     return (
       <div className={styles.tabContent}>
         <div className={styles.errorMessage}>
           <p>æ²¡æœ‰æƒé™è®¿é—®ç¼–è¾‘ç®¡ç†ï¼Œè¯·ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜è´¦å·ç™»å½•ã€‚</p>
         </div>
       </div>
     );
   }
   ```

#### åç«¯æƒé™æ§åˆ¶

åœ¨ `backend/routes/admin.js` ä¸­ï¼š

1. **è§’è‰²å®šä¹‰**ï¼ˆç¬¬89-111è¡Œï¼‰ï¼š
   - `requireRole(...allowedRoles)` ä¸­é—´ä»¶
   - æ”¯æŒçš„è§’è‰²ï¼š`'super_admin'`, `'chief_editor'`, `'editor'`, `'finance'`, `'operator'`
   - `super_admin` æ‹¥æœ‰æ‰€æœ‰æƒé™

2. **æƒé™æ£€æŸ¥ä½ç½®**ï¼š
   - åœ¨è·¯ç”±çº§åˆ«ä½¿ç”¨ `requireRole()` ä¸­é—´ä»¶
   - ä¾‹å¦‚ï¼š`router.get('/api/admin/...', authenticateAdmin, requireRole('super_admin'), ...)`

## 3. ç®¡ç†å‘˜è´¦å·ä¸æƒé™ç›¸å…³å®ç°ç°çŠ¶

### åå°ç®¡ç†å‘˜æ•°æ®ç»“æ„

#### æ•°æ®åº“è¡¨ç»“æ„

**è¡¨å**ï¼š`admin`

**å­—æ®µç»“æ„**ï¼ˆåŸºäº `backend/create_admin_table.sql` å’Œ `backend/migrations/005_upgrade_admin_table_with_role_and_password_hash.sql`ï¼‰ï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¤‡æ³¨ |
|--------|------|------|------|
| `id` | INT | ä¸»é”®ï¼Œè‡ªå¢ | PRIMARY KEY |
| `name` | VARCHAR(100) | ç®¡ç†å‘˜ç”¨æˆ·å | UNIQUE |
| `password` | VARCHAR(255) | å¯†ç ï¼ˆæ”¯æŒå“ˆå¸Œå’Œæ˜æ–‡ï¼‰ | å·²æ”¯æŒ bcrypt å“ˆå¸Œ |
| `level` | INT | ç®¡ç†å‘˜çº§åˆ« | 1=æ™®é€šç®¡ç†å‘˜ï¼Œ2=è¶…çº§ç®¡ç†å‘˜ï¼ˆå·²åºŸå¼ƒï¼Œæ”¹ç”¨ roleï¼‰ |
| `role` | ENUM | è§’è‰² | 'super_admin', 'editor', 'finance', 'operator' |
| `status` | TINYINT(1) | è´¦å·çŠ¶æ€ | 1=å¯ç”¨ï¼Œ0=ç¦ç”¨ |
| `display_name` | VARCHAR(100) | æ˜¾ç¤ºåç§° | å¯é€‰ |
| `created_at` | DATETIME | åˆ›å»ºæ—¶é—´ | DEFAULT CURRENT_TIMESTAMP |

**æ³¨æ„**ï¼š
- `role` å­—æ®µåœ¨è¿ç§»è„šæœ¬ `005_upgrade_admin_table_with_role_and_password_hash.sql` ä¸­æ·»åŠ 
- `level` å­—æ®µå·²åºŸå¼ƒï¼Œä½†æ•°æ®åº“è¡¨ä¸­ä»å­˜åœ¨ï¼ˆå‘åå…¼å®¹ï¼‰
- å¯†ç æ”¯æŒ bcrypt å“ˆå¸Œå’Œæ˜æ–‡ï¼ˆè¿ç§»æœŸé—´å…¼å®¹ï¼‰

#### è§’è‰²æšä¸¾

**å®šä¹‰ä½ç½®**ï¼š`backend/routes/admin.js` ç¬¬89-111è¡Œ

**æ”¯æŒçš„è§’è‰²**ï¼š
- `super_admin`ï¼šè¶…çº§ç®¡ç†å‘˜ï¼ˆæ‹¥æœ‰æ‰€æœ‰æƒé™ï¼‰
- `chief_editor`ï¼šä¸»ç¼–
- `editor`ï¼šç¼–è¾‘
- `finance`ï¼šè´¢åŠ¡
- `operator`ï¼šè¿è¥

**æƒé™åˆ¤æ–­é€»è¾‘**ï¼š
```javascript
const requireRole = (...allowedRoles) => {
  return (req, res, next) => {
    // super_admin æ‹¥æœ‰æ‰€æœ‰æƒé™
    if (req.admin.role === 'super_admin') {
      return next();
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æƒé™
    if (!allowedRoles.includes(req.admin.role)) {
      return res.status(403).json({ 
        success: false, 
        message: 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®æ­¤åŠŸèƒ½' 
      });
    }
    
    next();
  };
};
```

### ç™»å½• & è·å–å½“å‰ç®¡ç†å‘˜ä¿¡æ¯æ–¹å¼

#### ç™»å½•æ¥å£

**è·¯ç”±**ï¼š`POST /api/admin/login`  
**æ–‡ä»¶ä½ç½®**ï¼š`backend/routes/admin.js` ç¬¬117-216è¡Œ

**è¿”å›æ•°æ®ç»“æ„**ï¼š
```json
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "id": 1,
    "name": "adminshi",
    "level": 1,
    "role": "super_admin",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**JWT Token å†…å®¹**ï¼ˆç¬¬183-192è¡Œï¼‰ï¼š
```javascript
const token = jwt.sign(
  { 
    adminId: admin.id, 
    name: admin.name, 
    level: admin.level,
    role: admin.role || 'editor'
  },
  'admin-secret-key',
  { expiresIn: '24h' }
);
```

#### å‰ç«¯è·å–å½“å‰ç®¡ç†å‘˜ä¿¡æ¯

**å­˜å‚¨ä½ç½®**ï¼š
- **Token**ï¼š`localStorage.getItem('adminToken')`ï¼ˆç¬¬238è¡Œï¼‰
- **ç®¡ç†å‘˜ä¿¡æ¯**ï¼šä» JWT Token ä¸­è§£ç è·å–ï¼ˆç¬¬292-304è¡Œï¼‰

**è·å–æ–¹å¼**ï¼ˆ`AdminPanel.tsx` ç¬¬317-345è¡Œï¼‰ï¼š
```tsx
useEffect(() => {
  const token = localStorage.getItem('adminToken');
  if (token) {
    setAdminToken(token);
    setIsAuthenticated(true);
    
    // è§£ç  token è·å–ç”¨æˆ·ä¿¡æ¯
    const decoded = decodeToken(token);
    if (decoded) {
      setCurrentAdminName(decoded.name || decoded.username || 'æœªçŸ¥ç”¨æˆ·');
      setCurrentAdminRole(decoded.role || '');
    }
  }
}, []);
```

**Token è§£ç å‡½æ•°**ï¼ˆç¬¬292-304è¡Œï¼‰ï¼š
```tsx
const decodeToken = (token: string) => {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  } catch (error) {
    console.error('è§£æ token å¤±è´¥:', error);
    return null;
  }
};
```

**çŠ¶æ€å˜é‡**ï¼š
- `currentAdminName`ï¼šå½“å‰ç®¡ç†å‘˜ç”¨æˆ·åï¼ˆç¬¬99è¡Œï¼‰
- `currentAdminRole`ï¼šå½“å‰ç®¡ç†å‘˜è§’è‰²ï¼ˆç¬¬100è¡Œï¼‰

#### åç«¯è®¤è¯ä¸­é—´ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š`backend/routes/admin.js` ç¬¬48-87è¡Œ

**`authenticateAdmin` ä¸­é—´ä»¶**ï¼š
- ä»è¯·æ±‚å¤´ä¸­æå– JWT Token
- éªŒè¯ Token æœ‰æ•ˆæ€§
- ä»æ•°æ®åº“æŸ¥è¯¢æœ€æ–°çš„ç®¡ç†å‘˜ä¿¡æ¯ï¼ˆåŒ…æ‹¬ `role`ã€`status`ï¼‰
- æ£€æŸ¥è´¦å·çŠ¶æ€ï¼ˆ`status === 0` æ—¶æ‹’ç»è®¿é—®ï¼‰
- å°†ç®¡ç†å‘˜ä¿¡æ¯é™„åŠ åˆ° `req.admin` å¯¹è±¡

**`req.admin` å¯¹è±¡ç»“æ„**ï¼š
```javascript
{
  adminId: number,
  name: string,
  level: number,
  role: string,  // 'super_admin' | 'editor' | 'finance' | 'operator'
  status: number  // 1=å¯ç”¨ï¼Œ0=ç¦ç”¨
}
```

### ç°æœ‰æƒé™/è§’è‰²æ§åˆ¶ç‚¹

#### 1. åç«¯è·¯ç”±çº§åˆ«æƒé™æ§åˆ¶

**ä½ç½®**ï¼š`backend/routes/admin.js`

**ä½¿ç”¨æ–¹å¼**ï¼š
```javascript
router.get('/api/admin/...', authenticateAdmin, requireRole('super_admin'), ...)
```

**ç¤ºä¾‹**ï¼š
- ç¼–è¾‘ç®¡ç†ç›¸å…³æ¥å£é€šå¸¸éœ€è¦ `requireRole('super_admin')`
- ç« èŠ‚å®¡æ‰¹æ¥å£éœ€è¦ `requireRole('super_admin', 'chief_editor', 'editor')`

#### 2. å‰ç«¯é¡µé¢çº§åˆ«æƒé™æ§åˆ¶

**ä½ç½®**ï¼š`frontend/src/pages/AdminPanel/AdminUserPage/index.tsx`

**å®ç°æ–¹å¼**ï¼š
- API è¯·æ±‚æ‹¦æˆªï¼ˆç¬¬31-40è¡Œï¼‰
- 403 é”™è¯¯æ—¶æ˜¾ç¤ºæƒé™ä¸è¶³æç¤ºï¼ˆç¬¬66-74è¡Œï¼‰

#### 3. å°è¯´æƒé™æ§åˆ¶ï¼ˆåŸºäºåˆåŒï¼‰

**ä½ç½®**ï¼š`backend/middleware/permissionMiddleware.js`

**å‡½æ•°**ï¼š
- `getNovelPermissionFilter(db, adminId, role)`ï¼šè·å–ç®¡ç†å‘˜æœ‰æƒé™çš„å°è¯´åˆ—è¡¨
- `checkNovelPermission(db, adminId, role, novelId)`ï¼šæ£€æŸ¥ç®¡ç†å‘˜æ˜¯å¦æœ‰æƒé™æ“ä½œæŒ‡å®šå°è¯´
- åŸºäº `novel_editor_contract` è¡¨è¿›è¡Œæƒé™åˆ¤æ–­

**æ³¨æ„**ï¼šè¿™æ˜¯**ä¸šåŠ¡æƒé™**ï¼ˆåŸºäºåˆåŒï¼‰ï¼Œè€Œé**ç³»ç»Ÿæƒé™**ï¼ˆåŸºäºè§’è‰²ï¼‰ã€‚

## 4. UI ç»„ä»¶ä¸æ ·å¼ä½“ç³»

### ä½¿ç”¨çš„ UI åº“

**å½“å‰çŠ¶æ€**ï¼š**æœªä½¿ç”¨ç¬¬ä¸‰æ–¹ UI åº“ï¼ˆå¦‚ Ant Designã€Element UI ç­‰ï¼‰**

- æ‰€æœ‰ UI ç»„ä»¶å‡ä¸º**è‡ªå®šä¹‰å®ç°**
- ä½¿ç”¨ **CSS Modules** è¿›è¡Œæ ·å¼ç®¡ç†
- æœªå‘ç° `import { Tabs, Table, Button } from 'antd'` ç­‰å¯¼å…¥è¯­å¥

### Tab ä¸èœå•çš„æ ·å¼æ¥æº

#### ç¼–è¾‘ç®¡ç†é¡µé¢ Tab æ ·å¼

**æ ·å¼æ–‡ä»¶**ï¼š`frontend/src/pages/AdminPanel/AdminUserPage/AdminUserPage.module.css`

**Tab ç›¸å…³æ ·å¼**ï¼ˆç¬¬44-51è¡Œï¼‰ï¼š
```css
.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 2px solid #e0e0e0;
}

.tab {
  padding: 10px 20px;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  font-size: 16px;
  color: #666;
}

.tab:hover {
  color: #1890ff;
}

.activeTab {
  color: #1890ff;
  border-bottom-color: #1890ff;
  font-weight: 600;
}
```

#### å·¦ä¾§å¯¼èˆªèœå•æ ·å¼

**æ ·å¼æ–‡ä»¶**ï¼š`frontend/src/pages/AdminPanel.module.css`

**èœå•ç›¸å…³æ ·å¼**ï¼š
- `.sidebar`ï¼šä¾§è¾¹æ å®¹å™¨
- `.navGroup`ï¼šåˆ†ç»„å®¹å™¨
- `.navGroupHeader`ï¼šåˆ†ç»„æ ‡é¢˜ï¼ˆå¯ç‚¹å‡»å±•å¼€/æŠ˜å ï¼‰
- `.navSubItems`ï¼šå­èœå•é¡¹å®¹å™¨
- `.navSubItem`ï¼šå•ä¸ªå­èœå•é¡¹
- `.navIcon`ï¼šèœå•å›¾æ ‡
- `.active`ï¼šæ¿€æ´»çŠ¶æ€æ ·å¼

**æ ·å¼ç‰¹ç‚¹**ï¼š
- ç®€æ´çš„æ‰å¹³åŒ–è®¾è®¡
- ä½¿ç”¨å›¾æ ‡ï¼ˆemojiï¼‰ä½œä¸ºè§†è§‰æ ‡è¯†
- æ¿€æ´»çŠ¶æ€ä½¿ç”¨è“è‰²é«˜äº®ï¼ˆ`#1890ff`ï¼‰
- åˆ†ç»„æ”¯æŒå±•å¼€/æŠ˜å åŠ¨ç”»

### å¯¹æ–°å¢"è´¦å·æƒé™ç®¡ç†"Tab çš„é£æ ¼å»ºè®®

#### 1. å¤ç”¨ç°æœ‰æ ·å¼

- **Tab æŒ‰é’®**ï¼šä½¿ç”¨ `AdminUserPage.module.css` ä¸­çš„ `.tab` å’Œ `.activeTab` æ ·å¼
- **å†…å®¹åŒºåŸŸ**ï¼šä½¿ç”¨ `.tabPanel` æ ·å¼ï¼ˆç¬¬105è¡Œï¼‰
- **è¡¨æ ¼**ï¼šä½¿ç”¨ `.adminTable` æ ·å¼ï¼ˆç¬¬64-79è¡Œï¼‰
- **æŒ‰é’®**ï¼šä½¿ç”¨ `.searchButton`ã€`.addButton` ç­‰ç°æœ‰æŒ‰é’®æ ·å¼

#### 2. ä¿æŒä¸€è‡´çš„è§†è§‰é£æ ¼

- **é¢œè‰²æ–¹æ¡ˆ**ï¼š
  - ä¸»è‰²è°ƒï¼š`#1890ff`ï¼ˆè“è‰²ï¼‰
  - æˆåŠŸï¼š`#52c41a`ï¼ˆç»¿è‰²ï¼‰
  - è­¦å‘Šï¼š`#fa8c16`ï¼ˆæ©™è‰²ï¼‰
  - é”™è¯¯ï¼š`#ff4d4f`ï¼ˆçº¢è‰²ï¼‰
- **é—´è·**ï¼šä½¿ç”¨ `20px` ä½œä¸ºä¸»è¦é—´è·å•ä½
- **åœ†è§’**ï¼šä½¿ç”¨ `4px` ä½œä¸ºä¸»è¦åœ†è§’å€¼
- **å­—ä½“**ï¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“æ ˆ

#### 3. ç»„ä»¶ç»“æ„å»ºè®®

å‚è€ƒ `AccountManagementTab.tsx` çš„ç»“æ„ï¼š
- é¡¶éƒ¨ï¼šæ ‡é¢˜å’Œæ“ä½œæŒ‰é’®ï¼ˆå¦‚"æ–°å¢æƒé™"ï¼‰
- ä¸­é—´ï¼šç­›é€‰åŒºåŸŸï¼ˆå¦‚æŒ‰è§’è‰²ã€æŒ‰æƒé™ç‚¹ç­›é€‰ï¼‰
- åº•éƒ¨ï¼šæ•°æ®è¡¨æ ¼ï¼ˆæ˜¾ç¤ºæƒé™åˆ—è¡¨ï¼‰
- å¼¹çª—ï¼šæ–°å¢/ç¼–è¾‘æƒé™çš„æ¨¡æ€æ¡†

#### 4. è§’è‰²æ ‡ç­¾æ ·å¼

å¤ç”¨ `AdminUserPage.module.css` ä¸­çš„è§’è‰²æ ‡ç­¾æ ·å¼ï¼ˆç¬¬81-112è¡Œï¼‰ï¼š
- `.roleSuperAdmin`ï¼šçº¢è‰²èƒŒæ™¯
- `.roleChiefEditor`ï¼šæ©™è‰²èƒŒæ™¯
- `.roleEditor`ï¼šè“è‰²èƒŒæ™¯
- `.roleFinance`ï¼šç»¿è‰²èƒŒæ™¯
- `.roleOperator`ï¼šç°è‰²èƒŒæ™¯

## 5. åç»­æ‰©å±•å»ºè®®ï¼ˆç®€è¦ï¼‰

### åœ¨ä»€ä¹ˆä½ç½®å®ç°"æŒ‰æƒé™æ§åˆ¶èœå•å¯è§æ€§"æœ€åˆé€‚

#### æ–¹æ¡ˆä¸€ï¼šåœ¨èœå•æ¸²æŸ“å‰è¿‡æ»¤ï¼ˆæ¨èï¼‰

**ä½ç½®**ï¼š`frontend/src/pages/AdminPanel.tsx` ç¬¬1636-1713è¡Œï¼ˆ"æ”¶ç›Šä¸ç¼–è¾‘ç®¡ç†"åˆ†ç»„æ¸²æŸ“å‰ï¼‰

**å®ç°æ€è·¯**ï¼š
1. ä» `currentAdminRole` è·å–å½“å‰ç®¡ç†å‘˜è§’è‰²
2. å®šä¹‰èœå•é¡¹æƒé™é…ç½®ï¼ˆå¦‚ `menuPermissions` å¯¹è±¡ï¼‰
3. åœ¨æ¸²æŸ“èœå•é¡¹å‰è¿›è¡Œè¿‡æ»¤ï¼š
   ```tsx
   const menuItems = [
     { key: 'editor-management', label: 'ç¼–è¾‘ç®¡ç†', roles: ['super_admin'] },
     // ...
   ].filter(item => {
     if (currentAdminRole === 'super_admin') return true;
     return item.roles?.includes(currentAdminRole);
   });
   ```

**ä¼˜ç‚¹**ï¼š
- æƒé™æ§åˆ¶é›†ä¸­ï¼Œæ˜“äºç»´æŠ¤
- ç”¨æˆ·ä½“éªŒå¥½ï¼ˆçœ‹ä¸åˆ°æ— æƒé™çš„èœå•é¡¹ï¼‰

#### æ–¹æ¡ˆäºŒï¼šåœ¨èœå•é¡¹ç‚¹å‡»æ—¶æ£€æŸ¥

**ä½ç½®**ï¼šèœå•é¡¹çš„ `onClick` äº‹ä»¶å¤„ç†å‡½æ•°

**å®ç°æ€è·¯**ï¼š
- åœ¨ `setActiveTab` å‰æ£€æŸ¥æƒé™
- æ— æƒé™æ—¶æ˜¾ç¤ºæç¤ºï¼Œä¸åˆ‡æ¢ Tab

**ä¼˜ç‚¹**ï¼š
- å®ç°ç®€å•
- ç¼ºç‚¹ï¼šç”¨æˆ·ä»èƒ½çœ‹åˆ°æ— æƒé™çš„èœå•é¡¹

### å¯èƒ½æ–°å¢çš„æ•°æ®ç»“æ„/å­—æ®µï¼ˆåªåˆ—å»ºè®®ï¼Œä¸å†™å…·ä½“ä»£ç ï¼‰

#### 1. æƒé™ç‚¹è¡¨ï¼ˆ`admin_permission`ï¼‰

**å­—æ®µå»ºè®®**ï¼š
- `id`ï¼šä¸»é”®
- `key`ï¼šæƒé™ç‚¹å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ `'editor:create'`, `'editor:delete'`ï¼‰
- `name`ï¼šæƒé™ç‚¹åç§°ï¼ˆå¦‚ `'åˆ›å»ºç¼–è¾‘è´¦å·'`ï¼‰
- `category`ï¼šæƒé™åˆ†ç±»ï¼ˆå¦‚ `'editor_management'`, `'novel_review'`ï¼‰
- `description`ï¼šæƒé™æè¿°
- `created_at`ï¼šåˆ›å»ºæ—¶é—´

#### 2. è§’è‰²æƒé™å…³è”è¡¨ï¼ˆ`admin_role_permission`ï¼‰

**å­—æ®µå»ºè®®**ï¼š
- `id`ï¼šä¸»é”®
- `role`ï¼šè§’è‰²ï¼ˆENUMï¼š'super_admin', 'chief_editor', 'editor', 'finance', 'operator'ï¼‰
- `permission_key`ï¼šæƒé™ç‚¹æ ‡è¯†ï¼ˆå¤–é”®å…³è” `admin_permission.key`ï¼‰
- `created_at`ï¼šåˆ›å»ºæ—¶é—´

#### 3. ç®¡ç†å‘˜æƒé™æ‰©å±•è¡¨ï¼ˆ`admin_user_permission`ï¼Œå¯é€‰ï¼‰

**å­—æ®µå»ºè®®**ï¼š
- `id`ï¼šä¸»é”®
- `admin_id`ï¼šç®¡ç†å‘˜IDï¼ˆå¤–é”®å…³è” `admin.id`ï¼‰
- `permission_key`ï¼šæƒé™ç‚¹æ ‡è¯†ï¼ˆå¤–é”®å…³è” `admin_permission.key`ï¼‰
- `granted_by`ï¼šæˆæƒäººIDï¼ˆå¤–é”®å…³è” `admin.id`ï¼‰
- `created_at`ï¼šåˆ›å»ºæ—¶é—´

**ç”¨é€”**ï¼šæ”¯æŒä¸ºç‰¹å®šç®¡ç†å‘˜æˆäºˆé¢å¤–æƒé™ï¼ˆè¶…è¶Šè§’è‰²é»˜è®¤æƒé™ï¼‰

#### 4. æ‰©å±• `admin` è¡¨å­—æ®µï¼ˆå¯é€‰ï¼‰

**å­—æ®µå»ºè®®**ï¼š
- `permissions`ï¼šJSON å­—æ®µï¼Œå­˜å‚¨ç®¡ç†å‘˜çš„è‡ªå®šä¹‰æƒé™åˆ—è¡¨ï¼ˆç”¨äºå¿«é€ŸæŸ¥è¯¢ï¼‰
- `last_login_at`ï¼šæœ€åç™»å½•æ—¶é—´
- `email`ï¼šé‚®ç®±ï¼ˆå·²æœ‰ï¼Œè§è¿ç§»è„šæœ¬ `021_add_admin_email_and_payout_account.sql`ï¼‰

#### 5. æƒé™ç¼“å­˜æœºåˆ¶

**å»ºè®®**ï¼š
- åœ¨ JWT Token ä¸­ä¸åŒ…å«æƒé™åˆ—è¡¨ï¼ˆé¿å… Token è¿‡å¤§ï¼‰
- åœ¨ç™»å½•æ—¶æˆ–é¦–æ¬¡è®¿é—®æ—¶ï¼Œä»åç«¯è·å–æƒé™åˆ—è¡¨å¹¶ç¼“å­˜åˆ° `localStorage` æˆ– `sessionStorage`
- æƒé™å˜æ›´æ—¶ï¼Œæ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è·å–

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-12-01  
**åˆ†æèŒƒå›´**ï¼šåå°ç®¡ç†ç³»ç»Ÿç¼–è¾‘ç®¡ç†é¡µé¢ã€å·¦ä¾§å¯¼èˆªèœå•ã€ç®¡ç†å‘˜æƒé™ä½“ç³»  
**åˆ†æç›®çš„**ï¼šä¸ºæ–°å¢"è´¦å·æƒé™ç®¡ç†"Tab å’Œæƒé™ç®¡ç†åŠŸèƒ½åšå‡†å¤‡

