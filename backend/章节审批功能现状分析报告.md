# 章节审批功能现状分析报告

**生成时间**：2025-11-29  
**分析目标**：摸清后台管理系统「章节审批」选项卡页面的完整实现现状，重点分析权限控制、字段更新逻辑和前端按钮控制

---

## 一、后端路由与 Service 概览

### 1.1 章节审批相关路由

#### 1.1.1 获取章节列表

**路由**：`GET /api/admin/chapters`  
**文件位置**：`backend/routes/admin.js` 第 8574-8718 行  
**权限要求**：`authenticateAdmin` + `requireRole('super_admin', 'chief_editor', 'editor')`  
**功能**：
- 分页查询章节列表
- 支持按审核状态、小说ID、搜索关键词筛选
- 应用权限过滤（基于 `novel_editor_contract` 表）
- 返回章节基本信息、小说信息、编辑信息

**关键代码片段**：
```javascript
// 应用权限过滤
const permissionFilter = await getNovelPermissionFilter(
  db, 
  req.admin.adminId, 
  req.admin.role
);
```

#### 1.1.2 获取章节详情

**路由**：`GET /api/admin/chapter/:id`  
**文件位置**：`backend/routes/admin.js` 第 8720-8985 行  
**权限要求**：`authenticateAdmin` + `requireRole('super_admin', 'chief_editor', 'editor')`  
**功能**：
- 查询单个章节的详细信息
- 返回章节内容、审核状态、编辑信息（章节级别和小说级别）

**关键返回字段**：
- `editor_admin_id`：章节级别的编辑ID
- `chief_editor_admin_id`：章节级别的主编ID
- `novel_editor_admin_id`：小说级别的编辑ID（`novel.current_editor_admin_id`）
- `novel_chief_editor_admin_id`：小说级别的主编ID（`novel.chief_editor_admin_id`）
- `requires_chief_edit`：是否需要主编终审（运行时计算）
- `can_review`：当前管理员是否有权限审核此章节

#### 1.1.3 审核章节（统一接口）

**路由**：`POST /api/admin/chapter/review`  
**文件位置**：`backend/routes/admin.js` 第 8998-9002 行  
**Controller**：`backend/controllers/chapterReviewController.js` 第 17-92 行  
**Service**：`backend/services/chapterReviewService.js` 第 178-364 行  
**权限要求**：`authenticateAdmin` + `requireRole('super_admin', 'chief_editor', 'editor')`  
**功能**：
- 统一处理章节审核（支持 `approved`、`rejected`、`reviewing` 三种结果）
- 支持主编终审流程
- 更新 `chapter.review_status`、`chapter.editor_admin_id`、`chapter.chief_editor_admin_id`
- 写入审核日志到 `chapter_review_log` 表

**请求参数**：
```javascript
{
  chapter_id: number,
  result: 'approved' | 'rejected' | 'reviewing',
  comment?: string  // 审核备注
}
```

**关键逻辑**（`chapterReviewService.js` 第 178-364 行）：

1. **审核通过（`result='approved'`）**：
   - **无主编终审流程**（`requiresChief = false`）：
     - 直接设置为 `review_status = 'approved'`
     - **更新 `editor_admin_id`**：
       - 如果章节已有 `editor_admin_id` 且不等于当前审核人，且当前审核人是 `editor`，则拒绝（防止抢功）
       - 如果章节没有 `editor_admin_id`，则绑定当前审核人（`editor` 或 `super_admin`）
     - 设置 `reviewed_at = NOW()`
   
   - **有主编终审流程**（`requiresChief = true`）：
     - **编辑审核**（`adminRole = 'editor'`）：
       - 设置为 `review_status = 'pending_chief'`（等待主编终审）
       - **更新 `editor_admin_id`**：如果章节没有 `editor_admin_id`，则绑定当前审核人
     
     - **主编/超管终审**（`adminRole = 'chief_editor'` 或 `'super_admin'`）：
       - 设置为 `review_status = 'approved'`（最终通过）
       - **更新 `editor_admin_id`**：保持已有值，如果没有则使用小说的 `current_editor_admin_id`
       - **更新 `chief_editor_admin_id`**：如果章节没有主编归属，则绑定当前审核人（主编）或小说的 `chief_editor_admin_id`（超管）
       - 设置 `reviewed_at = NOW()`

2. **审核拒绝（`result='rejected'`）**：
   - 设置为 `review_status = 'rejected'`
   - **不更新 `editor_admin_id` 或 `chief_editor_admin_id`**（拒绝时不写入归属信息）
   - 设置 `reviewed_at = NOW()`

3. **保存为审核中（`result='reviewing'`）**：
   - 设置为 `review_status = 'reviewing'`
   - **不更新 `editor_admin_id` 或 `chief_editor_admin_id`**（标记为审核中时不写入归属信息）

**权限检查**：
- 使用 `checkNovelPermission` 检查当前管理员是否有权限审核该章节所属的小说
- 权限基于 `novel_editor_contract` 表：需要与该小说有有效的编辑合同

#### 1.1.4 批量审核章节

**路由**：`POST /api/admin/chapters/batch-review`  
**文件位置**：`backend/routes/admin.js` 第 9003-9005 行  
**Controller**：`backend/controllers/chapterReviewController.js` 第 98-181 行  
**Service**：`backend/services/chapterReviewService.js` 第 374-445 行  
**权限要求**：`authenticateAdmin` + `requireRole('super_admin', 'chief_editor', 'editor')`  
**功能**：
- 批量审核多个章节
- 只支持 `approved` 和 `rejected` 两种结果
- 更新 `chapter.review_status` 和 `chapter.editor_admin_id`

**关键逻辑**：
- 批量审核时，`editor_admin_id` 使用小说的 `current_editor_admin_id`（第 392-393 行）
- 如果小说没有 `current_editor_admin_id`，则设置为 `null`

#### 1.1.5 旧版审核接口（已废弃？）

**路由**：`POST /api/admin/review-chapter`  
**文件位置**：`backend/routes/admin.js` 第 9008-9102 行  
**权限要求**：`authenticateAdmin` + `requireRole('super_admin', 'chief_editor', 'editor')`  
**功能**：
- 旧版审核接口，功能与 `/chapter/review` 类似
- 只支持 `approve` 和 `reject` 两种操作
- **会更新 `chapter.editor_admin_id`**：使用小说的 `current_editor_admin_id`（第 9059-9063 行）

**注意**：该接口可能已被新接口 `/chapter/review` 替代，但代码中仍存在。

### 1.2 权限控制机制

#### 1.2.1 角色定义

**文件位置**：`backend/routes/admin.js` 第 89-111 行

**角色枚举**：
- `super_admin`：超级管理员（拥有所有权限）
- `chief_editor`：主编
- `editor`：编辑
- `finance`：财务
- `operator`：运营

**权限判断逻辑**：
```javascript
const requireRole = (...allowedRoles) => {
  return (req, res, next) => {
    // super_admin 拥有所有权限
    if (req.admin.role === 'super_admin') {
      return next();
    }
    
    // 检查是否有权限
    if (!allowedRoles.includes(req.admin.role)) {
      return res.status(403).json({ 
        success: false, 
        message: '权限不足，无法访问此功能' 
      });
    }
    
    next();
  };
};
```

#### 1.2.2 小说权限检查

**文件位置**：`backend/middleware/permissionMiddleware.js`

**函数**：`checkNovelPermission(db, adminId, role, novelId)`

**检查逻辑**：
- 查询 `novel_editor_contract` 表
- 条件：
  - `novel_id = novelId`
  - `editor_admin_id = adminId`（**注意：这里要求合同中的 `editor_admin_id` 等于当前管理员ID**）
  - `role = role`（编辑或主编）
  - `status = 'active'`
  - `start_date <= NOW()`
  - `(end_date IS NULL OR end_date >= NOW())`

**结论**：
- **只有与该小说有有效合同的编辑/主编才能审核该小说的章节**
- `super_admin` 可能绕过此检查（需要查看具体实现）

---

## 二、章节与管理员表结构摘要

### 2.1 chapter 表结构

**关键字段**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | int | 章节ID |
| `novel_id` | int | 小说ID |
| `editor_admin_id` | int | **章节级别的编辑ID**（审核通过时写入） |
| `chief_editor_admin_id` | int | **章节级别的主编ID**（主编终审通过时写入） |
| `review_status` | enum | 审核状态：`'submitted'`（已提交）、`'reviewing'`（审核中）、`'approved'`（已批准）、`'rejected'`（已拒绝）、`'pending_chief'`（等待主编终审）、`'draft'`（草稿） |
| `reviewed_at` | datetime | 审核时间 |
| `word_count` | int | 字数 |
| `content` | text | 章节内容 |

**审核状态说明**：
- `submitted`：作者提交，等待审核
- `reviewing`：编辑标记为"审核中"（不写入归属信息）
- `pending_chief`：编辑审核通过，等待主编终审
- `approved`：最终审核通过
- `rejected`：审核拒绝
- `draft`：草稿状态

### 2.2 novel 表结构

**关键字段**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | int | 小说ID |
| `current_editor_admin_id` | int | **小说级别的当前编辑ID** |
| `chief_editor_admin_id` | int | **小说级别的主编ID** |

### 2.3 admin 表结构

**关键字段**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | int | 管理员ID |
| `name` | varchar(100) | 管理员用户名 |
| `real_name` | varchar(100) | 真实姓名（用于结算实名） |
| `level` | int | 管理员级别（**当前代码中未使用**） |
| `role` | enum | **角色**：`'super_admin'`、`'chief_editor'`、`'editor'`、`'finance'`、`'operator'` |
| `status` | tinyint(1) | 状态（1=启用，0=禁用） |

**角色判定方式**：
- **使用 `role` 字段，不使用 `level` 字段**
- `role = 'super_admin'`：超级管理员
- `role = 'chief_editor'`：主编
- `role = 'editor'`：编辑

**结论**：
- **当前项目使用 `role` 字段区分"超级管理员"和"普通编辑"**
- `level` 字段存在但未被使用

### 2.4 novel_editor_contract 表结构

**关键字段**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | int | 合同ID |
| `novel_id` | int | 小说ID |
| `editor_admin_id` | int | **合同中的编辑ID**（必须等于管理员的ID） |
| `role` | enum | 角色：`'editor'`、`'chief_editor'` |
| `status` | enum | 状态：`'active'`、`'inactive'` |
| `start_date` | date | 合同开始日期 |
| `end_date` | date | 合同结束日期（可为 NULL） |

---

## 三、前端章节审批页面逻辑

### 3.1 页面组件结构

**主页面**：`frontend/src/pages/AdminPanel/ChapterApproval/index.tsx`  
**章节列表组件**：`frontend/src/pages/AdminPanel/ChapterApproval/ChapterList.tsx`（未详细查看）  
**章节详情组件**：`frontend/src/pages/AdminPanel/ChapterApproval/ChapterDetail.tsx`

### 3.2 数据加载逻辑

#### 3.2.1 章节列表加载

**API 调用**：`GET /api/admin/chapters`  
**代码位置**：`index.tsx` 第 124-168 行

**请求参数**：
- `page`：页码
- `limit`：每页数量
- `status`：审核状态筛选（可选）
- `novel_id`：小说ID筛选（可选）
- `search`：搜索关键词（可选）

**返回数据**：
- `chapters`：章节列表数组
- `pagination`：分页信息

#### 3.2.2 章节详情加载

**API 调用**：`GET /api/admin/chapter/:id`  
**代码位置**：`index.tsx` 第 175-202 行

**返回数据字段**（`ChapterDetailData` 接口，第 31-42 行）：
- `editor_admin_id`：章节级别的编辑ID
- `chief_editor_admin_id`：章节级别的主编ID
- `novel_editor_admin_id`：小说级别的编辑ID
- `novel_chief_editor_admin_id`：小说级别的主编ID
- `requires_chief_edit`：是否需要主编终审
- `can_review`：当前管理员是否有权限审核

**前端显示逻辑**（`ChapterDetail.tsx` 第 155-390 行）：
- **小说责任编辑**：显示 `novel_editor_admin_id` 对应的编辑名称（如果为空显示"未分配"）
- **主编**：显示 `novel_chief_editor_admin_id` 对应的主编名称（如果为空显示"未分配"）
- **本章责任编辑**：显示 `editor_admin_id` 对应的编辑名称（如果为空显示"未分配"）
- **本章主编**：显示 `chief_editor_admin_id` 对应的主编名称（如果为空显示"未分配"）

### 3.3 三个审核按钮的实现

#### 3.3.1 「保存为审核中」按钮

**代码位置**：`ChapterDetail.tsx` 第 394-400 行

**点击事件**：`handleReview('reviewing')`

**API 调用**：`POST /api/admin/chapter/review`  
**请求体**：
```javascript
{
  chapter_id: number,
  result: 'reviewing',
  comment: string  // 可为空
}
```

**disabled 条件**（第 396 行）：
```typescript
disabled={saving || chapter.review_status === 'reviewing' || !chapter.can_review}
```

**说明**：
- `saving`：正在保存中
- `chapter.review_status === 'reviewing'`：章节已经是"审核中"状态
- `!chapter.can_review`：当前管理员没有权限审核此章节

#### 3.3.2 「审核通过」按钮

**代码位置**：`ChapterDetail.tsx` 第 401-407 行

**点击事件**：`handleReview('approved')`

**API 调用**：`POST /api/admin/chapter/review`  
**请求体**：
```javascript
{
  chapter_id: number,
  result: 'approved',
  comment: string  // 可为空
}
```

**按钮文本逻辑**（第 93-112 行）：
- 如果不需要主编终审（`!requiresChiefEdit`）：显示"审核通过"
- 如果需要主编终审（`requiresChiefEdit`）：
  - 编辑（`isEditor`）：显示"提交主编终审"
  - 主编/超管（`isChiefEditor || isSuperAdmin`）：
    - 如果状态是 `pending_chief`：显示"终审通过"
    - 否则：显示"审核通过"

**disabled 条件**（第 403 行）：
```typescript
disabled={saving || !canApprove() || !chapter.can_review}
```

**`canApprove()` 函数逻辑**（第 115-129 行）：
```typescript
const canApprove = () => {
  if (requiresChiefEdit) {
    if (isEditor) {
      // 编辑可以提交主编终审
      return true;
    } else if (isChiefEditor || isSuperAdmin) {
      // 主编/超管可以终审通过（特别是 pending_chief 状态）
      return true;
    }
    return false;
  } else {
    // 不需要主编终审：编辑和超管都可以直接通过
    return isEditor || isSuperAdmin;
  }
};
```

**说明**：
- **编辑**：可以提交主编终审（如果有主编终审流程），或直接通过（如果没有主编终审流程）
- **主编**：只能终审通过（需要主编终审流程）
- **超管**：可以终审通过（需要主编终审流程），或直接通过（不需要主编终审流程）

#### 3.3.3 「审核拒绝」按钮

**代码位置**：`ChapterDetail.tsx` 第 408-414 行

**点击事件**：`handleReview('rejected')`

**API 调用**：`POST /api/admin/chapter/review`  
**请求体**：
```javascript
{
  chapter_id: number,
  result: 'rejected',
  comment: string  // 必填
}
```

**disabled 条件**（第 410 行）：
```typescript
disabled={saving || !reviewComment.trim() || !chapter.can_review}
```

**说明**：
- `saving`：正在保存中
- `!reviewComment.trim()`：审核备注为空（拒绝时必须填写备注）
- `!chapter.can_review`：当前管理员没有权限审核此章节

**前端验证**（第 137-140 行）：
```typescript
if (result === 'rejected' && !reviewComment.trim()) {
  alert('拒绝时必须填写审核备注');
  return;
}
```

### 3.4 当前管理员角色获取

**代码位置**：`index.tsx` 第 66-83 行

**获取方式**：
- 从 JWT token 中解码获取 `role` 字段
- 存储到 `currentAdminRole` state 中
- 传递给 `ChapterDetail` 组件

**代码片段**：
```typescript
const token = localStorage.getItem('adminToken');
const base64Url = token.split('.')[1];
const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
  return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
}).join(''));
const decoded = JSON.parse(jsonPayload);
setCurrentAdminRole(decoded.role || '');
```

---

## 四、目前修改 chapter.editor_admin_id 的所有场景

### 4.1 章节审核通过时

**文件位置**：`backend/services/chapterReviewService.js`

#### 场景 1：编辑审核通过（无主编终审流程）

**代码位置**：第 229-260 行

**条件**：
- `result = 'approved'`
- `requiresChief = false`（不需要主编终审）
- `adminRole = 'editor'` 或 `'super_admin'`

**更新逻辑**：
```javascript
// 防止抢功：如果章节已有编辑归属，且不是当前审核人，则拒绝
if (chapter.editor_admin_id && chapter.editor_admin_id !== adminId) {
  if (adminRole === 'editor') {
    throw new Error('该章节已由其他编辑审核通过，不能修改责任编辑归属');
  } else if (adminRole === 'super_admin') {
    throw new Error('该章节已由其他编辑审核通过，不能修改责任编辑归属');
  }
}

// 如果还没有绑定责任编辑，则绑定当前审核人
let finalEditorId = chapter.editor_admin_id;
if (!finalEditorId) {
  if (adminRole === 'editor' || adminRole === 'super_admin') {
    finalEditorId = adminId;
  } else {
    finalEditorId = editorAdminId;  // 使用小说的 current_editor_admin_id
  }
}

await db.execute(
  `UPDATE chapter SET 
   review_status = ?,
   reviewed_at = NOW(),
   editor_admin_id = ?
   WHERE id = ?`,
  [finalStatus, finalEditorId, chapter_id]
);
```

**结论**：
- **如果章节已有 `editor_admin_id` 且不等于当前审核人，则拒绝修改**（防止抢功）
- **如果章节没有 `editor_admin_id`，则绑定当前审核人**（`editor` 或 `super_admin`）

#### 场景 2：编辑审核通过（有主编终审流程）

**代码位置**：第 264-285 行

**条件**：
- `result = 'approved'`
- `requiresChief = true`（需要主编终审）
- `adminRole = 'editor'`

**更新逻辑**：
```javascript
// 防止抢功：如果章节已有编辑归属，且不是当前审核人，则拒绝
if (chapter.editor_admin_id && chapter.editor_admin_id !== adminId) {
  throw new Error('该章节已由其他编辑审核通过，不能修改责任编辑归属');
}

// 如果还没有绑定责任编辑，则绑定当前审核人
let finalEditorId = chapter.editor_admin_id;
if (!finalEditorId) {
  finalEditorId = adminId;
}

await db.execute(
  `UPDATE chapter SET 
   review_status = ?,
   editor_admin_id = ?
   WHERE id = ?`,
  [finalStatus, finalEditorId, chapter_id]
);
```

**结论**：
- **编辑审核通过时，绑定 `editor_admin_id = 当前审核人ID`**
- **如果章节已有 `editor_admin_id` 且不等于当前审核人，则拒绝修改**

#### 场景 3：主编/超管终审通过

**代码位置**：第 287-318 行

**条件**：
- `result = 'approved'`
- `requiresChief = true`（需要主编终审）
- `adminRole = 'chief_editor'` 或 `'super_admin'`

**更新逻辑**：
```javascript
// 保持已有的 editor_admin_id，如果没有则使用小说的当前编辑
let finalEditorId = chapter.editor_admin_id || editorAdminId;

// 如果还没有主编归属，则绑定当前审核人
let finalChiefEditorId = chapter.chief_editor_admin_id;
if (!finalChiefEditorId) {
  if (adminRole === 'chief_editor') {
    finalChiefEditorId = adminId;
  } else if (adminRole === 'super_admin') {
    // super_admin 终审时，如果没有主编归属，设置为小说的主编（如果有）
    finalChiefEditorId = novel.chief_editor_admin_id || null;
  }
}

await db.execute(
  `UPDATE chapter SET 
   review_status = ?,
   reviewed_at = NOW(),
   editor_admin_id = COALESCE(?, editor_admin_id),
   chief_editor_admin_id = COALESCE(?, chief_editor_admin_id)
   WHERE id = ?`,
  [finalStatus, finalEditorId, finalChiefEditorId, chapter_id]
);
```

**结论**：
- **主编终审通过时，保持已有的 `editor_admin_id`，如果没有则使用小说的 `current_editor_admin_id`**
- **更新 `chief_editor_admin_id`**：如果章节没有主编归属，则绑定当前审核人（主编）或小说的 `chief_editor_admin_id`（超管）

### 4.2 批量审核时

**文件位置**：`backend/services/chapterReviewService.js` 第 374-445 行

**更新逻辑**：
```javascript
// 获取每个章节的编辑ID（使用小说的 current_editor_admin_id）
const chapterEditorMap = {};
for (const chapter of chapters) {
  const editorId = await this.getNovelEditorId(chapter.novel_id);
  chapterEditorMap[chapter.id] = editorId;
}

// 批量更新
await db.execute(
  `UPDATE chapter SET ${updateFields.join(', ')} WHERE id = ?`,
  [result, editorId, chapterId]  // editorId 来自小说的 current_editor_admin_id
);
```

**结论**：
- **批量审核时，`editor_admin_id` 使用小说的 `current_editor_admin_id`**
- **如果小说没有 `current_editor_admin_id`，则设置为 `null`**

### 4.3 旧版审核接口（已废弃？）

**文件位置**：`backend/routes/admin.js` 第 9008-9102 行

**更新逻辑**：
```javascript
if (action === 'approve') {
  await db.execute(
    'UPDATE chapter SET review_status = ?, is_released = 1, release_date = NOW() WHERE id = ?',
    ['approved', chapterId]
  );
}
```

**结论**：
- **旧版接口不更新 `editor_admin_id`**（只更新 `review_status`）

---

## 五、与目标需求的差距简要结论

### 5.1 当前实现总结

1. **权限控制**：
   - ✅ 使用 `role` 字段区分"超级管理员"和"普通编辑"
   - ✅ 章节审批接口要求 `requireRole('super_admin', 'chief_editor', 'editor')`
   - ✅ 基于 `novel_editor_contract` 表检查是否有权限审核特定小说

2. **`chapter.editor_admin_id` 更新逻辑**：
   - ✅ 编辑审核通过时，如果章节没有 `editor_admin_id`，则绑定当前审核人
   - ✅ 如果章节已有 `editor_admin_id` 且不等于当前审核人，则拒绝修改（防止抢功）
   - ✅ 主编终审通过时，保持已有的 `editor_admin_id`，如果没有则使用小说的 `current_editor_admin_id`

3. **前端按钮控制**：
   - ✅ 「保存为审核中」按钮：根据 `chapter.review_status` 和 `chapter.can_review` 控制
   - ✅ 「审核通过」按钮：根据 `canApprove()` 函数和 `chapter.can_review` 控制
   - ✅ 「审核拒绝」按钮：根据 `reviewComment` 和 `chapter.can_review` 控制
   - ❌ **没有基于 `chapter.editor_admin_id` 对按钮做限制**（例如：只有章节的 `editor_admin_id` 等于当前管理员ID时才能审核）

### 5.2 与目标需求的差距

**目标需求**（推测）：
- 区分"超级管理员审批"和"普通编辑审批"
- 基于 `chapter.editor_admin_id` 对按钮做限制（例如：只有章节的 `editor_admin_id` 等于当前管理员ID时才能审核）

**当前实现**：
- ✅ **已经区分"超级管理员"和"普通编辑"**：使用 `role` 字段
- ✅ **已经基于角色控制按钮**：`canApprove()` 函数根据角色判断
- ❌ **没有基于 `chapter.editor_admin_id` 对按钮做限制**：
  - 当前逻辑：只要 `chapter.can_review = true`（有权限审核该小说），就可以审核
  - 没有检查：`chapter.editor_admin_id` 是否等于当前管理员ID

**结论**：
- **当前实现已经区分"超级管理员审批"和"普通编辑审批"**（通过 `role` 字段和 `canApprove()` 函数）
- **当前实现没有基于 `chapter.editor_admin_id` 对按钮做限制**（只检查是否有权限审核该小说，不检查是否是章节的负责编辑）

---

## 六、其他发现

### 6.1 审核日志

**表名**：`chapter_review_log`

**结构**：
- `chapter_id`：章节ID
- `admin_id`：审核人ID
- `admin_role`：审核人角色
- `action`：审核动作（`approved`、`rejected`、`reviewing`）
- `comment`：审核备注
- `created_at`：创建时间

**唯一约束**：`(chapter_id, admin_id)` - 每个编辑对每个章节只有一条最终审核记录

### 6.2 主编终审流程

**判断逻辑**（`chapterReviewService.js` 第 206-219 行）：
- 检查小说是否有 `chief_editor_admin_id`
- 检查该主编是否有有效合同（`novel_editor_contract`）
- 如果两者都满足，则 `requiresChief = true`

**状态流转**：
- `submitted` → `reviewing`（编辑标记为审核中）
- `reviewing` → `pending_chief`（编辑审核通过，等待主编终审）
- `pending_chief` → `approved`（主编终审通过）

---

**报告完成时间**：2025-11-29  
**结论**：当前实现已经区分"超级管理员审批"和"普通编辑审批"，但没有基于 `chapter.editor_admin_id` 对按钮做限制。

