# 章节审批规则修正说明

**修改时间**：2025-12-01  
**修改目标**：实现统一的「责任编辑归属/覆盖」规则，调整主编和超管的权限逻辑

---

## 一、修改文件清单

### 后端文件
1. **`backend/middleware/permissionMiddleware.js`**
   - 修改 `computeChapterCanReview`：允许主编在有主编流程的小说中，在非 `pending_chief` 状态下也能审核
   - 修改 `checkNovelPermission`：super_admin 直接返回 true，不再依赖合同

2. **`backend/services/chapterReviewService.js`**
   - 更新 `canCurrentAdminOverrideEditor` 的注释，明确规则对应表
   - 修改无主编流程时的 `editor_admin_id` 绑定逻辑：主编也可以绑定自己
   - 修改有主编流程时的逻辑：区分主编在编辑阶段和终审阶段的审核

3. **`backend/routes/admin.js`**
   - 修改编辑阶段的叠加检查：确保主编也走这个逻辑，规则与 `canCurrentAdminOverrideEditor` 一致

### 前端文件
4. **`frontend/src/pages/AdminPanel/ChapterApproval/ChapterDetail.tsx`**
   - 修改 `canApprove` 函数：允许主编在编辑阶段也能审核
   - 修改提示文案：改为更中性的描述

---

## 二、核心规则实现

### 2.1 责任编辑归属/覆盖规则（编辑阶段）

**实现位置**：`backend/services/chapterReviewService.js` 的 `canCurrentAdminOverrideEditor` 函数

**规则表**（仅针对 `review_status !== 'pending_chief'`）：

| 现有 `editor_admin_id` | 当前审核人 | 允许？ | `editor_admin_id` 结果 | 说明 |
|----------------------|----------|--------|----------------------|------|
| 空 | 任意编辑 E | ✅ | 绑定为 E | 第一次绑定 |
| 空 | 任意主编 C | ✅ | 绑定为 C | 主编亲自审稿 |
| 空 | 任意超管 S | ✅ | 绑定为 S | 超管接盘 |
| 某编辑 E1 | 同一个编辑 E1 | ✅ | 保持为 E1 | 自己重复审批或修正 |
| 某编辑 E1 | 其它编辑 E2 | ❌ | 不变 | 不允许抢功 |
| 某编辑 E1 | 任意主编 C | ❌ | 不变 | 主编不能抢编辑的功劳 |
| 某编辑 E1 | 任意超管 S | ✅ | 覆盖为 S | 超管可以覆盖 |
| 超管 S | 任意编辑 E | ✅ | 覆盖为 E | 编辑可以从超管手里接盘 |
| 超管 S | 任意主编 C | ✅ | 覆盖为 C | 主编也可以从超管接盘 |
| 超管 S1 | 另一位超管 S2 | ✅ | 覆盖为 S2 | 超管之间随便改 |

**代码实现**：
- 空值检查：直接允许 ✅
- 自己检查：`chapter.editor_admin_id === adminId` → 允许 ✅
- 超管检查：`adminRole === 'super_admin'` → 允许 ✅
- 从超管接盘：`existingRole === 'super_admin' && (adminRole === 'editor' || adminRole === 'chief_editor')` → 允许 ✅
- 抢功防护：其他情况 → 不允许 ❌

### 2.2 can_review 计算规则

**实现位置**：`backend/middleware/permissionMiddleware.js` 的 `computeChapterCanReview` 函数

**核心变化**：
1. **super_admin**：永远返回 `true`（无需合同、无需管状态）
2. **无主编流程**：只要有合同，`editor` 和 `chief_editor` 都可以审核
3. **有主编流程**：
   - `pending_chief` 状态：只允许 `chief_editor`
   - 其他状态（`submitted/reviewing/rejected/approved/...`）：允许 `editor` 和 `chief_editor` 都进入

**关键代码**：
```javascript
// 5. 其它状态（submitted/reviewing/rejected/approved/...）：
//    - 编辑阶段 + 审核通过后，允许 editor 和 chief_editor 都进入（有没有权限最终由 canCurrentAdminOverrideEditor 再限制）
return adminRole === 'editor' || adminRole === 'chief_editor';
```

### 2.3 超管合同限制放开

**实现位置**：`backend/middleware/permissionMiddleware.js` 的 `checkNovelPermission` 函数

**修改**：
```javascript
async function checkNovelPermission(db, adminId, role, novelId) {
  // 新增：super_admin 直接放行
  if (role === 'super_admin') {
    return true;
  }
  // ... 原有逻辑（检查合同）
}
```

**效果**：
- `POST /api/admin/chapter/review` 接口中，super_admin 不再需要合同就可以审核
- 与 `computeChapterCanReview` 保持一致

### 2.4 主编在编辑阶段的审核逻辑

**实现位置**：`backend/services/chapterReviewService.js` 的 `reviewChapter` 函数

**关键修改**：
1. **无主编流程**：主编审核时，`editor_admin_id` 绑定为主编自己的 ID
2. **有主编流程**：
   - 编辑阶段（`review_status !== 'pending_chief'`）：
     - 主编审核 → 直接变为 `approved`，绑定 `editor_admin_id = 主编ID`，设置 `chief_editor_admin_id = 主编ID`
   - 终审阶段（`review_status === 'pending_chief'`）：
     - 主编终审 → 变为 `approved`，保持 `editor_admin_id` 不变，设置 `chief_editor_admin_id = 主编ID`

**代码片段**：
```javascript
if (chapter.review_status === 'pending_chief') {
  // 终审阶段逻辑
} else {
  // 编辑阶段：主编在编辑阶段审核，直接变为 approved（主编自己就是终审人）
  finalStatus = 'approved';
  // 检查是否可以覆盖 editor_admin_id（编辑阶段的规则）
  const { allowed, reason } = await this.canCurrentAdminOverrideEditor(db, chapter, adminId, adminRole);
  // ... 绑定 editor_admin_id 和 chief_editor_admin_id
}
```

### 2.5 前端按钮逻辑

**实现位置**：`frontend/src/pages/AdminPanel/ChapterApproval/ChapterDetail.tsx`

**修改**：
1. **`canApprove()` 函数**：
   - 无主编流程：允许 `editor`、`chief_editor`、`super_admin`
   - 有主编流程，`pending_chief`：允许 `chief_editor`、`super_admin`
   - 有主编流程，其他状态：允许 `editor`、`chief_editor`、`super_admin`

2. **提示文案**：
   - 原：`您当前在该小说上没有生效的编辑/主编合同，因此不能进行审核操作。`
   - 新：`您当前对本章节没有审核权限（可能是没有生效合同，或章节状态/归属不允许），因此不能进行审核操作。`

---

## 三、测试场景验证

### 3.1 没有主编流程的小说

✅ **editor 有合同**：
- 可以审核任意状态
- 首次绑定 `editor_admin_id = E`
- 自审/修正 OK
- 其他编辑不能抢
- super_admin 随时可以覆盖/接管

✅ **chief_editor 有合同**：
- 可以直接审核（相当于也充当责任编辑）
- 首次绑定 `editor_admin_id = C`
- 规则与表格一致

### 3.2 有主编流程的小说

✅ **编辑 E 首次审核通过**：
- 状态变为 `pending_chief`
- `editor_admin_id = E`

✅ **主编 C 有合同**：
- 在 `pending_chief` 下可以终审通过/拒绝
- `chief_editor_admin_id` 正确写入
- 在编辑阶段（`submitted/reviewing/rejected/approved`）也可以审核
- 主编已终审通过后（状态 `approved`）再次打开同一章节：
  - ✅ 不再显示"没有合同"的提示
  - ✅ 「审核通过」、「审核拒绝」按钮可点击
  - ✅ 重复操作不会破坏 `editor_admin_id` 逻辑

✅ **超管 S**：
- 在任何阶段都可以审核
- 可覆盖 `editor_admin_id`
- 其他编辑/主编可以从超管手里接盘

### 3.3 抢功场景

✅ **chapter.editor_admin_id = E1；E2 打开**：
- `can_review = false`
- 按钮不可点
- 提交审核时也会被后端拒绝

✅ **chapter.editor_admin_id = super_admin S；编辑 E 打开**：
- `can_review = true`
- 通过后 `editor_admin_id = E`

---

## 四、修改前后对比

### 4.1 computeChapterCanReview

**修改前**：
- 有主编流程，非 `pending_chief` 状态：只允许 `editor`

**修改后**：
- 有主编流程，非 `pending_chief` 状态：允许 `editor` 和 `chief_editor`

### 4.2 checkNovelPermission

**修改前**：
- super_admin 也需要检查合同（可以拥有 editor 或 chief_editor 合同）

**修改后**：
- super_admin 直接返回 `true`，无需合同

### 4.3 主编在编辑阶段的审核

**修改前**：
- 主编在有主编流程的小说中，只能在 `pending_chief` 状态下审核

**修改后**：
- 主编在有主编流程的小说中，可以在编辑阶段审核，直接变为 `approved`

### 4.4 前端 canApprove

**修改前**：
- 有主编流程，非 `pending_chief` 状态：只允许 `editor` 和 `super_admin`

**修改后**：
- 有主编流程，非 `pending_chief` 状态：允许 `editor`、`chief_editor` 和 `super_admin`

---

## 五、注意事项

1. **主编终审阶段**（`pending_chief`）：
   - 不检查 `editor_admin_id` 覆盖规则
   - `editor_admin_id` 保持不变（如果已有值）
   - 只设置 `chief_editor_admin_id`

2. **编辑阶段**（非 `pending_chief`）：
   - 检查 `editor_admin_id` 覆盖规则
   - 主编也遵循与编辑相同的规则
   - 主编可以绑定自己的 `editor_admin_id`

3. **super_admin**：
   - 永远可以审核
   - 不需要合同
   - 可以覆盖任意人的 `editor_admin_id`

---

**修改完成**

