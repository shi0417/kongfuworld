# 作品数据评价系统 - 基础设施实施总结

**实施时间**：2025-01-XX  
**实施范围**：数据库表、统计服务、定时任务、后端接口骨架

---

## 一、实施内容概览

### 1.1 数据库表

创建了两张统计表：

1. **`novel_advanced_stats_daily`** - 每日高级统计表
   - 存储每本小说每天的详细统计数据
   - 包含：访问指标、阅读深度、解锁数据、收入数据、评价数据、社区互动数据

2. **`novel_overall_scores`** - 综合评分表
   - 存储每本小说的累计数据和综合评分
   - 包含：累计基础数据、评价数据、五个维度评分、综合评分

### 1.2 统计服务

创建了 `backend/services/novelAnalyticsService.js`，实现：

- `computeDailyStatsForDate(statDate)` - 计算指定日期的每日统计数据
- `recomputeOverallScores()` - 重新计算所有小说的综合评分
- 五个维度评分函数（占位实现，便于后续调整）：
  - `calculatePopularityScore()` - 热度评分
  - `calculateEngagementScore()` - 参与度评分
  - `calculateMonetizationScore()` - 变现能力评分
  - `calculateReputationScore()` - 口碑评分
  - `calculateCommunityScore()` - 社区活跃度评分
- `calculateFinalScore()` - 综合评分（加权平均）
- `startDailyStatsTask()` - 启动定时任务
- `manualTriggerDailyStats()` - 手动触发统计（用于测试）

### 1.3 定时任务

在 `backend/server.js` 中集成了定时任务：

- **执行时间**：每天凌晨 03:00（Asia/Shanghai 时区）
- **执行内容**：
  1. 计算昨天的每日统计数据（`computeDailyStatsForDate`）
  2. 重新计算所有小说的综合评分（`recomputeOverallScores`）

### 1.4 后端接口

创建了两组路由：

#### 1.4.1 统计分析接口（`backend/routes/analytics.js`）

- `GET /api/analytics/novels/:novelId/daily`
  - 获取指定小说的每日统计数据
  - 支持 `startDate` 和 `endDate` 查询参数
  - 返回：`novel_advanced_stats_daily` 的列表

- `GET /api/analytics/novels/:novelId/summary`
  - 获取指定小说的综合评分摘要
  - 返回：`novel_overall_scores` 中该小说的维度评分 + 累计数据

#### 1.4.2 排行榜接口（`backend/routes/rankings.js`）

- `GET /api/rankings/overall`
  - 获取综合排行榜（按 `final_score` 排序）
  - 支持 `limit` 和 `offset` 分页参数
  - 返回：小说列表（带基本信息和评分）

- `GET /api/rankings/hot-24h`（预留）
- `GET /api/rankings/hot-7d`（预留）
- `GET /api/rankings/top-rated`（预留）
- `GET /api/rankings/best-seller`（预留）

---

## 二、新增文件清单

### 2.1 数据库迁移文件

```
backend/migrations/
├── create_novel_analytics_tables.sql          # SQL 迁移脚本
└── execute_novel_analytics_migration.js      # Node.js 执行脚本
```

### 2.2 服务文件

```
backend/services/
└── novelAnalyticsService.js                  # 统计分析服务
```

### 2.3 路由文件

```
backend/routes/
├── analytics.js                               # 统计分析接口
└── rankings.js                                # 排行榜接口
```

### 2.4 修改的文件

```
backend/server.js                              # 集成路由和定时任务
```

---

## 三、数据库表结构

### 3.1 novel_advanced_stats_daily 表

**用途**：存储每本小说每天的详细统计数据

**关键字段**：
- `novel_id`, `stat_date` - 唯一键
- `views`, `unique_readers` - 基础访问指标
- `views_24h`, `views_7d` - 时间窗口浏览量
- `effective_reads`, `avg_stay_duration_sec`, `finish_rate`, `avg_read_chapters_per_user` - 阅读深度指标
- `paid_unlock_count`, `time_unlock_count`, `paid_reader_count` - 解锁相关指标
- `chapter_revenue`, `champion_revenue`, `champion_active_count` - 收入指标
- `rating_count`, `rating_sum`, `avg_rating_snapshot` - 评价指标
- `new_comments`, `new_paragraph_comments`, `new_comment_likes`, `new_comment_dislikes` - 社区互动指标

**索引**：
- `PRIMARY KEY (id)`
- `UNIQUE KEY unique_novel_date (novel_id, stat_date)`
- `KEY idx_stat_date (stat_date)`
- `KEY idx_novel_id (novel_id)`

### 3.2 novel_overall_scores 表

**用途**：存储每本小说的累计数据和综合评分

**关键字段**：
- `novel_id` - 主键
- `total_views`, `total_unique_readers` - 累计基础数据
- `total_chapter_revenue`, `total_champion_revenue` - 累计收入
- `total_comments`, `total_paragraph_comments` - 累计评论数
- `avg_rating`, `rating_count` - 评价数据
- `popularity_score`, `engagement_score`, `monetization_score`, `reputation_score`, `community_score` - 维度评分（0-100分）
- `final_score` - 综合评分（0-100分）
- `last_calculated_at` - 最后计算时间

**索引**：
- `PRIMARY KEY (novel_id)`

---

## 四、统计逻辑说明

### 4.1 每日统计计算逻辑

**数据来源**：
- `reading_log` - 阅读记录
- `chapter_unlocks` - 章节解锁记录
- `user_champion_subscription_record` - Champion订阅支付记录
- `review` - 评价记录
- `comment` - 评论记录
- `paragraph_comment` - 段落评论记录
- `novel_statistics` - 现有每日统计表（用于24h/7d浏览量）

**计算方式**：
- 按 `novel_id` 和 `stat_date` 维度聚合
- 使用 `INSERT ... ON DUPLICATE KEY UPDATE` 实现插入或更新

### 4.2 综合评分计算逻辑

**数据来源**：
- `novel_advanced_stats_daily` - 每日统计表（累计聚合）
- `reading_log` - 阅读记录（补充唯一读者数）
- `comment`, `paragraph_comment` - 评论记录（补充评论数）
- `review` - 评价记录（计算平均评分）

**评分维度**：
1. **热度评分**（popularity_score）：基于浏览量、唯一读者数
2. **参与度评分**（engagement_score）：基于有效阅读数、平均停留时长、完成率、平均阅读章节数
3. **变现能力评分**（monetization_score）：基于章节解锁收入、Champion订阅收入、付费读者数
4. **口碑评分**（reputation_score）：基于平均评分、评价数量
5. **社区活跃度评分**（community_score）：基于评论数、段落评论数、互动数

**综合评分**：
- 加权平均：热度25% + 参与度25% + 变现能力20% + 口碑15% + 社区活跃度15%

**注意**：当前评分函数为占位实现，使用简单的对数映射。后续可根据运营经验调整权重和映射曲线。

---

## 五、使用说明

### 5.1 执行数据库迁移

**方式1：使用 Node.js 脚本（推荐）**

```bash
cd backend/migrations
node execute_novel_analytics_migration.js
```

**方式2：直接执行 SQL 文件**

```bash
mysql -u root -p kongfuworld < backend/migrations/create_novel_analytics_tables.sql
```

### 5.2 启动定时任务

定时任务会在服务器启动时自动启动（在 `backend/server.js` 中已集成）。

**手动触发测试**：

```javascript
const novelAnalyticsService = require('./services/novelAnalyticsService');

// 计算指定日期的统计数据
await novelAnalyticsService.computeDailyStatsForDate('2025-01-01');

// 重新计算综合评分
await novelAnalyticsService.recomputeOverallScores();

// 或使用手动触发函数（同时执行上述两个操作）
await novelAnalyticsService.manualTriggerDailyStats('2025-01-01');
```

### 5.3 调用接口

**获取每日统计数据**：
```bash
GET /api/analytics/novels/1/daily?startDate=2025-01-01&endDate=2025-01-31
```

**获取综合评分摘要**：
```bash
GET /api/analytics/novels/1/summary
```

**获取综合排行榜**：
```bash
GET /api/rankings/overall?limit=20&offset=0
```

---

## 六、注意事项

### 6.1 数据完整性

- 每日统计任务会在每天凌晨3点自动执行，统计昨天的数据
- 如果某天统计任务失败，可以手动调用 `computeDailyStatsForDate()` 补算
- 综合评分会在每日统计完成后自动重新计算

### 6.2 性能考虑

- 每日统计任务会遍历所有已发布的小说，如果小说数量很大，可能需要较长时间
- 建议在低峰期执行（当前设置为凌晨3点）
- 如果数据量很大，可以考虑分批处理或使用队列

### 6.3 评分函数调整

- 当前评分函数为占位实现，使用简单的对数映射
- 后续可根据运营经验调整：
  - 修改 `calculatePopularityScore()` 等函数的权重和映射曲线
  - 修改 `calculateFinalScore()` 的维度权重

### 6.4 预留接口

以下接口已预留但未实现，后续可根据需求补充：
- `GET /api/rankings/hot-24h` - 24小时热榜
- `GET /api/rankings/hot-7d` - 7天热榜
- `GET /api/rankings/top-rated` - 高分榜
- `GET /api/rankings/best-seller` - 畅销榜

---

## 七、后续工作建议

1. **完善评分函数**：根据运营经验调整各维度评分的权重和映射曲线
2. **实现预留接口**：补充24小时热榜、7天热榜、高分榜、畅销榜等接口
3. **前端展示**：基于接口数据实现前端展示页面
4. **性能优化**：如果数据量很大，考虑使用缓存、分批处理、队列等优化手段
5. **数据验证**：添加数据验证和异常处理，确保统计数据的准确性

---

**实施完成时间**：2025-01-XX  
**实施人员**：AI Assistant

