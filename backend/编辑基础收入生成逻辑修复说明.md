# 编辑基础收入生成逻辑修复说明

**修复时间**：2025-12-01  
**修复文件**：`backend/services/editorBaseIncomeService.js`

---

## 一、主要修改点

### 1.1 添加精度处理函数

**位置**：文件开头（第 48-57 行）

**新增函数**：
```javascript
function toDecimal(val, scale = 6) {
  if (val == null) return null;
  return Number(val).toFixed(scale);
}
```

**用途**：
- `gross_book_income_usd`、`editor_income_usd` → `scale = 6`（对应 DECIMAL(18,6)）
- `contract_share_percent`、`editor_share_percent` → `scale = 4`（对应 DECIMAL(8,4)）

### 1.2 修复合同加载逻辑（重点）

**位置**：`loadNovelRoleContracts` 函数（第 340-410 行）

**修改内容**：
1. **添加 `settlementMonth` 参数**：函数签名从 `loadNovelRoleContracts(db, spendings)` 改为 `loadNovelRoleContracts(db, spendings, settlementMonth)`
2. **添加日期过滤条件**：
   ```sql
   AND (start_date IS NULL OR start_date <= ?)
   AND (end_date IS NULL OR end_date >= ?)
   ```
3. **查询字段增加**：添加了 `start_chapter_id` 和 `end_chapter_id`（虽然暂不参与过滤，但保留字段）
4. **日志增强**：改为 `合同加载完毕: 小说数=%d, 其中有编辑合同=%d, 有主编合同=%d`

**修复前的问题**：
- 只检查 `share_type = 'percent_of_book'` 和 `status = 'active'`
- 没有检查 `start_date` 和 `end_date`，导致可能选中未生效的合同

**修复后的行为**：
- 只选择在结算月有效的合同（`start_date <= settlementMonth` 且 `end_date >= settlementMonth` 或 `end_date IS NULL`）

### 1.3 完善章节解锁上下文加载

**位置**：`loadChapterUnlockContext` 函数（第 151-213 行）

**修改内容**：
- 在查询 `chapter` 时添加了 `is_released` 字段
- `chapterMap` 中包含了 `is_released` 信息（虽然当前逻辑未使用，但保留以备后续扩展）

### 1.4 修复订阅章节统计加载

**位置**：`loadSubscriptionChapterStats` 函数（第 221-294 行）

**修改内容**：
- 在查询条件中添加了 `AND is_released = 1`
- 确保只统计已发布且已审核通过的章节

**修复前的问题**：
- 只检查 `review_status = 'approved'`，没有检查 `is_released`

**修复后的行为**：
- 只统计 `review_status = 'approved' AND is_released = 1` 的章节

### 1.5 完善章节解锁生成逻辑

**位置**：`generateFromChapterUnlock` 函数（第 412-500 行）

**修改内容**：
1. **使用局部数组统计**：使用 `unlockRows` 数组单独统计章节解锁记录
2. **精度处理**：所有金额和比例字段使用 `toDecimal` 处理
3. **警告日志增强**：添加了 `admin_id` 信息
4. **统计日志**：改为 `章节解锁生成明细: %d 条 (spending条数=%d)`

**关键逻辑**：
- 编辑收入：`income = amount_usd × editorContract.share_percent`
- 主编收入：`income = amount_usd × chiefContract.share_percent`
- 如果章节有编辑/主编但没有对应合同，记录警告但不生成记录

### 1.6 完善订阅生成逻辑

**位置**：`generateFromSubscription` 函数（第 502-615 行）

**修改内容**：
1. **使用局部数组统计**：使用 `subscriptionRows` 数组单独统计订阅记录
2. **精度处理**：所有金额和比例字段使用 `toDecimal` 处理
3. **统计日志**：改为 `订阅生成明细: %d 条 (spending条数=%d)`

**关键逻辑**：
- 编辑收入：`income = amount_usd × editorContract.share_percent × (editorWordCount / totalWordCount)`
- 主编收入：`income = amount_usd × chiefContract.share_percent × (chiefWordCount / totalWordCount)`
- 每个有字数的编辑/主编都会生成一条记录

### 1.7 完善主函数汇总日志

**位置**：`generateEditorBaseIncomeForMonth` 函数（第 151-173 行）

**修改内容**：
- 添加了汇总日志，包含：
  - 删除旧记录数
  - 新增记录总数
  - 章节解锁记录数
  - 订阅记录数

**日志格式**：
```
[editor-base-income] 生成完成 2025-10-01: 删除旧记录=X 条, 新增记录=Y 条 (章节解锁=A, 订阅=B)
```

### 1.8 添加业务说明注释

**位置**：文件开头（第 4-46 行）

**内容**：
- 章节解锁计算公式
- 订阅计算公式
- 合同有效期判定规则
- 调用示例

---

## 二、修复前后对比

### 2.1 合同查询逻辑

**修复前**：
```sql
WHERE novel_id IN (?)
  AND share_type = 'percent_of_book'
  AND status = 'active'
```

**修复后**：
```sql
WHERE novel_id IN (?)
  AND share_type = 'percent_of_book'
  AND status = 'active'
  AND (start_date IS NULL OR start_date <= ?)
  AND (end_date IS NULL OR end_date >= ?)
```

### 2.2 订阅章节统计

**修复前**：
```sql
WHERE novel_id IN (?)
  AND review_status = 'approved'
```

**修复后**：
```sql
WHERE novel_id IN (?)
  AND review_status = 'approved'
  AND is_released = 1
```

### 2.3 金额精度处理

**修复前**：
```javascript
gross_book_income_usd: amount.toNumber(),
editor_income_usd: income.toNumber()
```

**修复后**：
```javascript
gross_book_income_usd: toDecimal(amount.toNumber(), 6),
editor_income_usd: toDecimal(income.toNumber(), 6),
contract_share_percent: toDecimal(sharePercent.toNumber(), 4),
editor_share_percent: toDecimal(sharePercent.toNumber(), 4)
```

---

## 三、测试建议

### 3.1 测试场景

1. **章节解锁测试**：
   - 有编辑合同的小说：应该生成编辑收入记录
   - 有主编合同的小说：应该生成主编收入记录
   - 没有合同的小说：应该记录警告，不生成记录

2. **订阅测试**：
   - 有多个编辑的小说：应该按字数比例分配
   - 有主编的小说：应该为主编也生成记录
   - 没有已审核章节的小说：应该记录警告，不生成记录

3. **合同日期测试**：
   - `start_date > settlementMonth`：不应该选中该合同
   - `end_date < settlementMonth`：不应该选中该合同
   - `start_date <= settlementMonth AND (end_date IS NULL OR end_date >= settlementMonth)`：应该选中该合同

### 3.2 调用示例

```javascript
const { generateEditorBaseIncomeForMonth } = require('./services/editorBaseIncomeService');

// 生成 2025-10 的编辑基础收入
const result = await generateEditorBaseIncomeForMonth('2025-10');

console.log('生成结果:', result);
// {
//   month: '2025-10-01',
//   totalSpendings: 24,
//   totalEditorIncomeUsd: '0.123456',
//   recordsInserted: 10,
//   unlockRowsCount: 8,
//   subscriptionRowsCount: 2
// }

// 重新生成某月数据：直接再次调用即可（函数开头会自动删除当月旧数据）
await generateEditorBaseIncomeForMonth('2025-10');
```

---

## 四、注意事项

1. **精度处理**：所有金额和比例字段都使用 `toDecimal` 处理，返回字符串格式，MySQL 的 DECIMAL 类型会自动转换

2. **合同日期过滤**：现在会正确过滤掉未生效的合同，解决了 2025-10 月"没有合同"的问题

3. **订阅章节统计**：现在只统计已发布且已审核通过的章节，确保数据准确性

4. **日志增强**：所有关键步骤都有详细的日志输出，方便调试和排查问题

---

**修复完成**

