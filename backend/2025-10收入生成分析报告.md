# 2025-10 编辑基础收入生成分析报告

**分析时间**：2025-12-01  
**结算月份**：2025-10-01  
**reader_spending 记录数**：24 条  
**实际生成的 editor_income_monthly 记录数**：10 条

---

## 一、问题分析

### 1.1 为什么只生成了 10 条记录？

**原因**：24 条 `reader_spending` 记录中，只有 10 条对应的章节有 `editor_admin_id` 或 `chief_editor_admin_id`，其余 14 条记录的章节 `editor_admin_id` 和 `chief_editor_admin_id` 都是 `NULL`。

### 1.2 业务逻辑说明

根据当前代码逻辑：
- **只有章节的 `editor_admin_id` 不为 NULL 且有对应编辑合同时，才会生成编辑收入**
- **只有章节的 `chief_editor_admin_id` 不为 NULL 且有对应主编合同时，才会生成主编收入**

这是**正确的业务逻辑**，因为：
- 如果章节没有指定编辑/主编，说明该章节还没有被审核或分配责任人
- 没有责任人的章节不应该产生编辑/主编收入

---

## 二、详细数据统计

### 2.1 按章节归属情况分类

| 章节归属情况 | 记录数 | 说明 |
|------------|--------|------|
| 有 `editor_admin_id` 且有合同 | 8 条 | 生成编辑收入 |
| 有 `chief_editor_admin_id` 且有合同 | 2 条 | 生成主编收入 |
| `editor_admin_id` 为 NULL | 16 条 | 不生成收入 |
| `chief_editor_admin_id` 为 NULL | 22 条 | 不生成收入 |

### 2.2 实际生成的收入记录明细

| reader_spending.id | novel_id | chapter_id | editor_admin_id | chief_editor_admin_id | 合同ID | 分成比例 | 收入类型 | 收入金额(USD) |
|-------------------|----------|------------|-----------------|----------------------|--------|---------|---------|-------------|
| 286 | 13 | 1441 | 2 | NULL | 11 | 0.0500 | 编辑 | 0.009241 |
| 287 | 13 | 1443 | 3 | NULL | 11 | 0.0500 | 编辑 | 0.007243 |
| 291 | 7 | 1209 | 3 | NULL | 7 | 0.0800 | 编辑 | 0.018382 |
| 295 | 1 | 848 | 2 | 5 | 1 / 6 | 0.1000 / 0.0300 | 编辑+主编 | 0.026474 + 0.007942 |
| 296 | 1 | 852 | 2 | 5 | 1 / 6 | 0.1000 / 0.0300 | 编辑+主编 | 0.009990 + 0.002997 |
| 297 | 7 | 1204 | 3 | NULL | 7 | 0.0800 | 编辑 | 0.019581 |
| 298 | 7 | 1197 | 3 | NULL | 7 | 0.0800 | 编辑 | 0.023976 |
| 302 | 11 | 1343 | 3 | NULL | 8 | 0.0700 | 编辑 | 0.011888 |

**总计**：10 条记录（8 条编辑收入 + 2 条主编收入）

---

## 三、未生成收入的记录明细

### 3.1 章节 `editor_admin_id` 为 NULL 的记录（16 条）

| reader_spending.id | novel_id | chapter_id | 原因 |
|-------------------|----------|------------|------|
| 279 | 13 | 1350 | `editor_admin_id` 为 NULL |
| 280 | 13 | 1351 | `editor_admin_id` 为 NULL |
| 281 | 13 | 1366 | `editor_admin_id` 为 NULL |
| 282 | 13 | 1368 | `editor_admin_id` 为 NULL |
| 283 | 13 | 1369 | `editor_admin_id` 为 NULL |
| 284 | 13 | 1373 | `editor_admin_id` 为 NULL |
| 285 | 13 | 1376 | `editor_admin_id` 为 NULL |
| 288 | 13 | 1385 | `editor_admin_id` 为 NULL |
| 289 | 13 | 1386 | `editor_admin_id` 为 NULL |
| 290 | 11 | 1338 | `editor_admin_id` 为 NULL |
| 292 | 10 | 1314 | `editor_admin_id` 为 NULL |
| 293 | 10 | 1316 | `editor_admin_id` 为 NULL |
| 294 | 13 | 1355 | `editor_admin_id` 为 NULL |
| 299 | 10 | 1317 | `editor_admin_id` 为 NULL |
| 300 | 13 | 1397 | `editor_admin_id` 为 NULL |
| 301 | 11 | 1339 | `editor_admin_id` 为 NULL |

**说明**：这些章节虽然已经审核通过（`review_status = 'approved'`）且已发布（`is_released = 1`），但是 `editor_admin_id` 为 NULL，说明这些章节在审核时没有指定编辑责任人。

### 3.2 章节 `chief_editor_admin_id` 为 NULL 的记录（22 条）

除了 `reader_spending.id = 295` 和 `296` 这两条记录有 `chief_editor_admin_id = 5` 外，其余 22 条记录的 `chief_editor_admin_id` 都是 NULL。

---

## 四、合同信息汇总

### 4.1 各小说的合同情况

| novel_id | 编辑合同ID | 编辑合同分成比例 | 主编合同ID | 主编合同分成比例 |
|----------|-----------|----------------|-----------|----------------|
| 1 | 1 | 0.1000 | 6 | 0.0300 |
| 7 | 7 | 0.0800 | - | - |
| 10 | 5 | 0.0500 | - | - |
| 11 | 8 | 0.0700 | - | - |
| 13 | 11 | 0.0500 | - | - |

**说明**：所有合同在 2025-10-01 都是有效的（`status = 'active'`，日期范围符合要求）。

---

## 五、结论

### 5.1 代码逻辑正确

当前代码逻辑是**正确的**：
- ✅ 正确查询了合同（考虑了日期有效期）
- ✅ 正确检查了章节的 `editor_admin_id` 和 `chief_editor_admin_id`
- ✅ 正确计算了收入金额
- ✅ 正确生成了 10 条收入记录

### 5.2 数据问题

**问题在于数据本身**：
- 24 条 `reader_spending` 记录中，有 16 条对应的章节 `editor_admin_id` 为 NULL
- 这些章节虽然已经审核通过并发布，但是没有指定编辑责任人
- 因此，这些章节不应该产生编辑收入

### 5.3 建议

如果需要为这些章节生成收入，需要：

1. **检查章节审核流程**：
   - 为什么这些章节审核通过后 `editor_admin_id` 还是 NULL？
   - 是否应该在审核时自动设置 `editor_admin_id`？

2. **数据修复**（如果需要）：
   - 如果这些章节确实有编辑责任人，需要手动更新 `chapter.editor_admin_id`
   - 更新后重新运行生成逻辑即可

3. **业务规则确认**：
   - 确认"没有编辑责任人的章节是否应该产生收入"
   - 如果应该产生，需要修改业务逻辑（例如：使用小说级别的 `current_editor_admin_id` 作为默认值）

---

## 六、数据验证

### 6.1 生成的收入记录验证

运行以下 SQL 可以验证生成的收入记录：

```sql
SELECT 
  eim.id,
  eim.editor_admin_id,
  eim.role,
  eim.novel_id,
  eim.month,
  eim.source_spend_id,
  eim.source_type,
  eim.chapter_id,
  eim.gross_book_income_usd,
  eim.contract_share_percent,
  eim.editor_share_percent,
  eim.editor_income_usd,
  rs.amount_usd AS spending_amount,
  c.editor_admin_id AS chapter_editor_id,
  c.chief_editor_admin_id AS chapter_chief_id
FROM editor_income_monthly eim
LEFT JOIN reader_spending rs ON rs.id = eim.source_spend_id
LEFT JOIN chapter_unlocks cu ON cu.id = rs.source_id
LEFT JOIN chapter c ON c.id = cu.chapter_id
WHERE eim.month = '2025-10-01'
ORDER BY eim.source_spend_id, eim.role;
```

### 6.2 收入金额验证

- **总 reader_spending 金额**：24 条记录的总金额
- **总编辑收入**：10 条记录的总收入 = `0.137714` USD
- **收入比例**：符合合同分成比例（5% - 10%）

---

**报告生成完成**

